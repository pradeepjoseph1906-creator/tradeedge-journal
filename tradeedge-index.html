<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TradeEdge ‚Äî Daily Journal</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=IBM+Plex+Mono:wght@300;400;500&family=IBM+Plex+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<!-- Google Sign-In -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
<style>
:root {
  --bg: #0a0a0b;
  --surface: #111113;
  --surface2: #18181c;
  --border: #2a2a2f;
  --gold: #c9a84c;
  --gold-light: #e8c97a;
  --gold-dim: #7a6030;
  --red: #e05252;
  --green: #4caf88;
  --blue: #5b8af5;
  --orange: #f5a623;
  --purple: #b57bee;
  --text: #e8e6df;
  --text-muted: #6b6a64;
  --text-dim: #9a9890;
  --nifty50-color: #5b8af5;
  --nifty500-color: #b57bee;
  --trader-color: #c9a84c;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'IBM Plex Sans', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 9999;
  opacity: 0.4;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 20px 40px;
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0;
  background: rgba(10,10,11,0.95);
  backdrop-filter: blur(16px);
  z-index: 200;
}
.logo { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; color: var(--gold); }
.logo span { color: var(--text-muted); font-weight: 400; font-size: 11px; display: block; letter-spacing: 2.5px; text-transform: uppercase; margin-top: -2px; font-family: 'IBM Plex Mono', monospace; }
.header-right { display: flex; align-items: center; gap: 20px; }
.header-meta { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--text-muted); text-align: right; }
.pnl-badge { padding: 6px 16px; border-radius: 4px; font-family: 'IBM Plex Mono', monospace; font-size: 15px; font-weight: 500; border: 1px solid; transition: all 0.3s; }
.pnl-badge.profit { color: var(--green); border-color: var(--green); background: rgba(76,175,136,0.08); }
.pnl-badge.loss { color: var(--red); border-color: var(--red); background: rgba(224,82,82,0.08); }
.pnl-badge.neutral { color: var(--text-muted); border-color: var(--border); }

/* NAV TABS */
.nav-tabs {
  display: flex; gap: 0;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
  padding: 0 40px;
  position: sticky; top: 65px;
  z-index: 190;
  backdrop-filter: blur(12px);
}
.nav-tab {
  padding: 14px 24px;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 11px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text-muted);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
  user-select: none;
}
.nav-tab:hover { color: var(--text-dim); }
.nav-tab.active { color: var(--gold); border-bottom-color: var(--gold); }

/* STATUS BAR */
.status-bar {
  background: var(--surface); border-bottom: 1px solid var(--border);
  padding: 14px 40px;
  display: flex; align-items: center; gap: 32px; flex-wrap: wrap;
}
.status-item { display: flex; flex-direction: column; gap: 2px; }
.status-label { font-size: 9px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; }
.status-value { font-size: 17px; font-family: 'IBM Plex Mono', monospace; font-weight: 500; }
.status-value.green { color: var(--green); }
.status-value.red { color: var(--red); }
.status-value.gold { color: var(--gold); }
.progress-section { flex: 1; min-width: 180px; }
.progress-label { display: flex; justify-content: space-between; font-size: 9px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; margin-bottom: 6px; }
.progress-bar { height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 2px; background: linear-gradient(90deg, var(--gold-dim), var(--gold)); transition: width 0.6s ease; }
.day-complete-btn { margin-left: auto; padding: 8px 18px; background: transparent; border: 1px solid var(--gold-dim); color: var(--gold); border-radius: 4px; font-family: 'IBM Plex Mono', monospace; font-size: 10px; letter-spacing: 1px; text-transform: uppercase; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
.day-complete-btn:hover { background: rgba(201,168,76,0.1); border-color: var(--gold); }
.day-complete-btn.done { background: rgba(76,175,136,0.15); border-color: var(--green); color: var(--green); }

/* PAGE SECTIONS */
.page { display: none; }
.page.active { display: block; }

/* ‚îÄ‚îÄ JOURNAL PAGE ‚îÄ‚îÄ */
.journal-layout {
  display: grid;
  grid-template-columns: 1fr 360px;
  min-height: calc(100vh - 130px);
}
.left-panel { padding: 28px 40px; border-right: 1px solid var(--border); }
.right-panel { background: var(--surface); overflow-y: auto; position: sticky; top: 130px; max-height: calc(100vh - 130px); }

.section-title {
  font-family: 'Playfair Display', serif; font-size: 12px; text-transform: uppercase;
  letter-spacing: 3px; color: var(--gold-dim); margin-bottom: 18px;
  display: flex; align-items: center; gap: 12px;
}
.section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

/* FORM */
.trade-form { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 22px; margin-bottom: 28px; }
.form-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 14px; margin-bottom: 14px; }
.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-group label { font-size: 9px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; }
.form-group input, .form-group select, .form-group textarea {
  background: var(--bg); border: 1px solid var(--border); color: var(--text);
  padding: 9px 11px; border-radius: 4px; font-family: 'IBM Plex Mono', monospace;
  font-size: 12px; outline: none; transition: border-color 0.2s;
}
.form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--gold-dim); }
.form-group select option { background: var(--surface2); }

.checklist-row { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 14px; }
.check-item { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 9px 12px; border: 1px solid var(--border); border-radius: 4px; transition: all 0.2s; user-select: none; }
.check-item:hover { border-color: var(--gold-dim); }
.check-item.checked { border-color: var(--green); background: rgba(76,175,136,0.06); }
.check-item input[type=checkbox] { display: none; }
.check-dot { width: 13px; height: 13px; border-radius: 2px; border: 1px solid var(--border); flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 9px; transition: all 0.2s; }
.check-item.checked .check-dot { background: var(--green); border-color: var(--green); color: #fff; }
.check-text { font-size: 10px; color: var(--text-dim); font-family: 'IBM Plex Mono', monospace; }

.flag-row { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }
.flag-chip { padding: 5px 13px; border-radius: 20px; border: 1px solid var(--border); font-size: 10px; font-family: 'IBM Plex Mono', monospace; cursor: pointer; transition: all 0.2s; user-select: none; }
.flag-chip.delayed-sl { color: var(--orange); } .flag-chip.delayed-sl.active { background: rgba(245,166,35,0.15); border-color: var(--orange); }
.flag-chip.revenge { color: var(--red); } .flag-chip.revenge.active { background: rgba(224,82,82,0.15); border-color: var(--red); }
.flag-chip.risky { color: var(--blue); } .flag-chip.risky.active { background: rgba(91,138,245,0.15); border-color: var(--blue); }
.flag-chip.fomo { color: var(--purple); } .flag-chip.fomo.active { background: rgba(181,123,238,0.15); border-color: var(--purple); }
.flag-chip.disciplined { color: var(--green); } .flag-chip.disciplined.active { background: rgba(76,175,136,0.15); border-color: var(--green); }

.form-actions { display: flex; gap: 10px; justify-content: flex-end; }
.btn-primary { padding: 9px 22px; background: var(--gold); color: #0a0a0b; border: none; border-radius: 4px; font-family: 'IBM Plex Mono', monospace; font-size: 11px; font-weight: 500; letter-spacing: 1px; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
.btn-primary:hover { background: var(--gold-light); transform: translateY(-1px); }
.btn-secondary { padding: 9px 22px; background: transparent; color: var(--text-muted); border: 1px solid var(--border); border-radius: 4px; font-family: 'IBM Plex Mono', monospace; font-size: 11px; letter-spacing: 1px; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
.btn-secondary:hover { color: var(--text); border-color: var(--text-dim); }

/* TRADE LOG */
.log-header { display: grid; grid-template-columns: 70px 55px 80px 80px 90px 55px 1fr 110px; gap: 10px; padding: 6px 18px; font-size: 9px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; margin-bottom: 4px; }
.trade-row { display: grid; grid-template-columns: 70px 55px 80px 80px 90px 55px 1fr 110px; align-items: center; gap: 10px; padding: 12px 18px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 7px; background: var(--surface); transition: background 0.2s; font-family: 'IBM Plex Mono', monospace; font-size: 11px; animation: fadeUp 0.3s ease; }
.trade-row:hover { background: var(--surface2); }
@keyframes fadeUp { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }
.trade-symbol { font-size: 12px; font-weight: 500; color: var(--text); }
.trade-dir { padding: 2px 7px; border-radius: 3px; font-size: 9px; font-weight: 500; letter-spacing: 1px; text-align: center; width: fit-content; }
.trade-dir.long { background: rgba(76,175,136,0.15); color: var(--green); }
.trade-dir.short { background: rgba(224,82,82,0.15); color: var(--red); }
.trade-col { color: var(--text-dim); }
.trade-pnl { font-size: 12px; font-weight: 500; }
.trade-pnl.pos { color: var(--green); }
.trade-pnl.neg { color: var(--red); }
.trade-flags { display: flex; gap: 3px; flex-wrap: wrap; }
.mini-flag { padding: 1px 6px; border-radius: 8px; font-size: 8px; letter-spacing: 0.3px; }
.mf-delayed { background: rgba(245,166,35,0.12); color: var(--orange); }
.mf-revenge { background: rgba(224,82,82,0.12); color: var(--red); }
.mf-risky { background: rgba(91,138,245,0.12); color: var(--blue); }
.mf-fomo { background: rgba(181,123,238,0.12); color: var(--purple); }
.mf-disciplined { background: rgba(76,175,136,0.12); color: var(--green); }
.ci { font-size: 10px; opacity: 0.25; }
.ci.ok { opacity: 1; }
.delete-trade { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 13px; padding: 2px 6px; border-radius: 3px; transition: all 0.15s; opacity: 0; }
.trade-row:hover .delete-trade { opacity: 1; }
.delete-trade:hover { color: var(--red); background: rgba(224,82,82,0.1); }

.empty-state { text-align: center; padding: 40px; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; font-size: 11px; border: 1px dashed var(--border); border-radius: 8px; }
.empty-state .icon { font-size: 28px; margin-bottom: 10px; opacity: 0.3; }

.force-stop-banner { display: none; background: linear-gradient(135deg, rgba(224,82,82,0.15), rgba(224,82,82,0.05)); border: 1px solid rgba(224,82,82,0.4); border-radius: 8px; padding: 14px 20px; margin-bottom: 22px; font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--red); letter-spacing: 0.5px; text-align: center; animation: pulseBorder 2s infinite; }
.force-stop-banner.show { display: block; }
@keyframes pulseBorder { 0%,100%{opacity:1} 50%{opacity:0.6} }

/* RIGHT PANEL */
.mindful-section { padding: 22px; border-bottom: 1px solid var(--border); }
.quote-card { background: linear-gradient(135deg, #15130e, #1a1710); border: 1px solid var(--gold-dim); border-radius: 8px; padding: 20px; position: relative; overflow: hidden; margin-bottom: 14px; }
.quote-card::before { content: '"'; position: absolute; top: -10px; left: 14px; font-family: 'Playfair Display', serif; font-size: 70px; color: var(--gold-dim); opacity: 0.25; line-height: 1; }
.quote-text { font-family: 'Playfair Display', serif; font-size: 13px; line-height: 1.75; color: var(--text); font-style: italic; margin-bottom: 10px; position: relative; z-index: 1; }
.quote-author { font-size: 9px; color: var(--gold); font-family: 'IBM Plex Mono', monospace; letter-spacing: 1.5px; text-transform: uppercase; }
.quote-nav { display: flex; gap: 6px; margin-top: 10px; }
.quote-btn { padding: 4px 10px; background: transparent; border: 1px solid var(--border); color: var(--text-muted); border-radius: 3px; font-size: 9px; font-family: 'IBM Plex Mono', monospace; cursor: pointer; transition: all 0.2s; }
.quote-btn:hover { border-color: var(--gold-dim); color: var(--gold); }

.breathing-widget { text-align: center; padding: 14px 0; }
.breath-ring { width: 90px; height: 90px; border-radius: 50%; border: 1.5px solid var(--border); margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; position: relative; }
.breath-ring-fill { position: absolute; inset: 7px; border-radius: 50%; background: radial-gradient(circle, rgba(201,168,76,0.3), rgba(201,168,76,0.05)); transform: scale(0.3); transition: transform 0s; }
.breath-ring-fill.inhale { transform: scale(1); transition: transform 4s ease-in-out; }
.breath-ring-fill.hold { transform: scale(1); }
.breath-ring-fill.exhale { transform: scale(0.3); transition: transform 6s ease-in-out; }
.breath-label { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: var(--gold); letter-spacing: 2px; text-transform: uppercase; }
.breath-instruction { font-size: 10px; color: var(--text-muted); margin-top: 3px; font-family: 'IBM Plex Mono', monospace; }
.breath-btn { margin-top: 10px; padding: 6px 18px; background: transparent; border: 1px solid var(--gold-dim); color: var(--gold); border-radius: 3px; font-size: 10px; font-family: 'IBM Plex Mono', monospace; cursor: pointer; letter-spacing: 1px; transition: all 0.2s; }
.breath-btn:hover { background: rgba(201,168,76,0.1); }

.suggestions-section { padding: 22px; border-bottom: 1px solid var(--border); }
.suggestion-card { padding: 12px 14px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid; font-size: 11px; line-height: 1.65; color: var(--text-dim); background: var(--bg); animation: fadeUp 0.4s ease; }
.suggestion-card.warning { border-color: var(--orange); background: rgba(245,166,35,0.04); }
.suggestion-card.danger { border-color: var(--red); background: rgba(224,82,82,0.04); }
.suggestion-card.positive { border-color: var(--green); background: rgba(76,175,136,0.04); }
.suggestion-card.info { border-color: var(--blue); background: rgba(91,138,245,0.04); }
.suggestion-label { font-size: 8px; text-transform: uppercase; letter-spacing: 1.5px; font-family: 'IBM Plex Mono', monospace; margin-bottom: 5px; font-weight: 500; }
.suggestion-card.warning .suggestion-label { color: var(--orange); }
.suggestion-card.danger .suggestion-label { color: var(--red); }
.suggestion-card.positive .suggestion-label { color: var(--green); }
.suggestion-card.info .suggestion-label { color: var(--blue); }

.stats-section { padding: 22px; }
.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.stat-box { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 11px 13px; }
.stat-box-label { font-size: 8px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; margin-bottom: 3px; }
.stat-box-value { font-size: 16px; font-family: 'IBM Plex Mono', monospace; font-weight: 500; color: var(--text); }
.stat-box-value.green { color: var(--green); }
.stat-box-value.red { color: var(--red); }
.stat-box-value.gold { color: var(--gold); }

/* ‚îÄ‚îÄ ANALYTICS PAGE ‚îÄ‚îÄ */
.analytics-page { padding: 32px 40px; }
.analytics-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
.analytics-title { font-family: 'Playfair Display', serif; font-size: 32px; color: var(--text); }
.analytics-title span { color: var(--gold); }
.analytics-subtitle { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--text-muted); margin-top: 6px; }

.nifty-status { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
.nifty-badge { display: flex; flex-direction: column; gap: 2px; padding: 10px 16px; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); }
.nifty-badge-label { font-size: 8px; text-transform: uppercase; letter-spacing: 1.5px; font-family: 'IBM Plex Mono', monospace; }
.nifty-badge-value { font-size: 14px; font-family: 'IBM Plex Mono', monospace; font-weight: 500; }
.nifty-status-text { font-size: 9px; font-family: 'IBM Plex Mono', monospace; color: var(--text-muted); }

/* KPI STRIP */
.kpi-strip { display: grid; grid-template-columns: repeat(6,1fr); gap: 12px; margin-bottom: 32px; }
.kpi-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
.kpi-label { font-size: 8px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; margin-bottom: 6px; }
.kpi-value { font-size: 22px; font-family: 'IBM Plex Mono', monospace; font-weight: 500; }
.kpi-value.green { color: var(--green); }
.kpi-value.red { color: var(--red); }
.kpi-value.gold { color: var(--gold); }
.kpi-sub { font-size: 9px; font-family: 'IBM Plex Mono', monospace; color: var(--text-muted); margin-top: 3px; }

/* CHART CONTAINERS */
.charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
.chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 22px; }
.chart-card.full { grid-column: 1/-1; }
.chart-title { font-family: 'Playfair Display', serif; font-size: 14px; color: var(--text); margin-bottom: 4px; }
.chart-subtitle { font-size: 9px; font-family: 'IBM Plex Mono', monospace; color: var(--text-muted); margin-bottom: 18px; letter-spacing: 0.5px; }
.chart-legend { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 14px; }
.legend-item { display: flex; align-items: center; gap: 6px; font-size: 10px; font-family: 'IBM Plex Mono', monospace; color: var(--text-dim); }
.legend-dot { width: 10px; height: 3px; border-radius: 2px; }

.period-tabs { display: flex; gap: 6px; margin-bottom: 16px; }
.period-tab { padding: 4px 12px; border-radius: 3px; font-size: 9px; font-family: 'IBM Plex Mono', monospace; letter-spacing: 1px; text-transform: uppercase; cursor: pointer; border: 1px solid var(--border); color: var(--text-muted); transition: all 0.2s; }
.period-tab.active { background: var(--gold); color: #0a0a0b; border-color: var(--gold); }
.period-tab:hover:not(.active) { border-color: var(--gold-dim); color: var(--gold); }

canvas { max-height: 280px; }

/* Behaviour Breakdown */
.behaviour-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 10px; }
.beh-card { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 14px; text-align: center; }
.beh-count { font-size: 28px; font-family: 'IBM Plex Mono', monospace; font-weight: 500; }
.beh-label { font-size: 9px; font-family: 'IBM Plex Mono', monospace; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }
.beh-impact { font-size: 10px; font-family: 'IBM Plex Mono', monospace; margin-top: 6px; }

.no-data-msg { text-align: center; padding: 60px; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; font-size: 12px; }
.no-data-msg .big { font-size: 36px; margin-bottom: 12px; opacity: 0.2; }

/* OVERLAY */
.overlay { display: none; position: fixed; inset: 0; background: rgba(10,10,11,0.95); backdrop-filter: blur(20px); z-index: 500; align-items: center; justify-content: center; flex-direction: column; gap: 14px; text-align: center; }
.overlay.show { display: flex; animation: fadeUp 0.4s ease; }
.overlay-eyebrow { font-family: 'IBM Plex Mono', monospace; font-size: 10px; letter-spacing: 3px; color: var(--gold-dim); text-transform: uppercase; }
.overlay-title { font-family: 'Playfair Display', serif; font-size: 52px; color: var(--gold); }
.overlay-pnl { font-family: 'IBM Plex Mono', monospace; font-size: 34px; }
.overlay-msg { font-size: 13px; color: var(--text-muted); max-width: 440px; line-height: 1.75; }
.overlay-close { margin-top: 20px; padding: 11px 30px; border: 1px solid var(--gold); color: var(--gold); background: transparent; border-radius: 4px; font-family: 'IBM Plex Mono', monospace; font-size: 11px; letter-spacing: 1px; cursor: pointer; transition: all 0.2s; text-transform: uppercase; }
.overlay-close:hover { background: rgba(201,168,76,0.1); }

/* IMPORT/EXPORT */
.data-controls { display: flex; gap: 10px; align-items: center; }
.data-btn { padding: 7px 16px; background: transparent; border: 1px solid var(--border); color: var(--text-muted); border-radius: 4px; font-family: 'IBM Plex Mono', monospace; font-size: 10px; letter-spacing: 1px; cursor: pointer; transition: all 0.2s; text-transform: uppercase; }
.data-btn:hover { border-color: var(--gold-dim); color: var(--gold); }


/* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
.login-screen {
  position: fixed; inset: 0; z-index: 1000;
  background: var(--bg);
  display: flex; align-items: center; justify-content: center;
  flex-direction: column;
}
.login-screen.hidden { display: none; }
.login-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 48px 40px;
  text-align: center;
  max-width: 380px;
  width: 100%;
}
.login-logo { font-family: 'Playfair Display', serif; font-size: 32px; font-weight: 700; color: var(--gold); margin-bottom: 4px; }
.login-tagline { font-family: 'IBM Plex Mono', monospace; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 32px; }
.login-divider { height: 1px; background: var(--border); margin: 24px 0; }
.login-security { font-family: 'IBM Plex Mono', monospace; font-size: 9px; color: var(--text-muted); line-height: 1.7; letter-spacing: 0.3px; }
.login-security span { color: var(--green); }
#g_id_signin { display: flex; justify-content: center; margin-bottom: 16px; }

/* ‚îÄ‚îÄ SYNC INDICATOR ‚îÄ‚îÄ */
.sync-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--text-muted);
  display: inline-block;
  margin-right: 5px;
  transition: background 0.3s;
}
.sync-dot.syncing { background: var(--orange); animation: pulse-dot 1s infinite; }
.sync-dot.synced { background: var(--green); }
.sync-dot.error { background: var(--red); }
@keyframes pulse-dot { 0%,100%{opacity:1} 50%{opacity:0.3} }
.sync-label { font-family: 'IBM Plex Mono', monospace; font-size: 9px; color: var(--text-muted); }

/* user avatar */
.user-avatar {
  width: 28px; height: 28px; border-radius: 50%;
  border: 1px solid var(--border);
  cursor: pointer;
}
.sign-out-btn {
  padding: 5px 12px; background: transparent; border: 1px solid var(--border);
  color: var(--text-muted); border-radius: 3px; font-family: 'IBM Plex Mono', monospace;
  font-size: 9px; cursor: pointer; letter-spacing: 1px; text-transform: uppercase;
  transition: all 0.2s;
}
.sign-out-btn:hover { border-color: var(--red); color: var(--red); }

/* loading spinner */
.loading-overlay {
  position: fixed; inset: 0; z-index: 900;
  background: rgba(10,10,11,0.85);
  display: flex; align-items: center; justify-content: center;
  flex-direction: column; gap: 16px;
}
.loading-overlay.hidden { display: none; }
.spinner {
  width: 36px; height: 36px;
  border: 2px solid var(--border);
  border-top-color: var(--gold);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--text-muted); letter-spacing: 1px; }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <div class="login-logo">TradeEdge</div>
    <div class="login-tagline">Your Private Trading Journal</div>
    <div id="g_id_signin"></div>
    <div class="login-divider"></div>
    <div class="login-security">
      <span>üîí Secure</span> ‚Äî Sign in with your Google account.<br>
      Your trade data is stored exclusively in<br>
      <span>your own Google Sheet</span> ‚Äî no third party has access.
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ LOADING OVERLAY ‚îÄ‚îÄ -->
<div class="loading-overlay hidden" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Loading your journal‚Ä¶</div>
</div>

.active-date-bar {
  display: flex; align-items: center; gap: 14px;
  padding: 10px 40px;
  background: var(--surface2);
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
}
.active-date-label { font-family: 'IBM Plex Mono', monospace; font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); }
.date-picker-input {
  background: var(--bg); border: 1px solid var(--border); color: var(--text);
  padding: 6px 10px; border-radius: 4px; font-family: 'IBM Plex Mono', monospace;
  font-size: 12px; outline: none; cursor: pointer; transition: border-color 0.2s;
  color-scheme: dark;
}
.date-picker-input:focus { border-color: var(--gold-dim); }
.date-jump-btn { padding: 5px 12px; background: transparent; border: 1px solid var(--border); color: var(--text-muted); border-radius: 3px; font-family: 'IBM Plex Mono', monospace; font-size: 10px; cursor: pointer; transition: all 0.2s; letter-spacing: 0.5px; }
.date-jump-btn:hover { border-color: var(--gold-dim); color: var(--gold); }
.date-jump-btn.today-btn { border-color: var(--gold-dim); color: var(--gold); }
.date-jump-btn.today-btn:hover { background: rgba(201,168,76,0.1); }
.viewing-past-badge { padding: 4px 12px; border-radius: 10px; background: rgba(91,138,245,0.12); border: 1px solid rgba(91,138,245,0.3); color: var(--blue); font-family: 'IBM Plex Mono', monospace; font-size: 10px; letter-spacing: 0.5px; }
.date-pnl-pill { padding: 4px 12px; border-radius: 10px; font-family: 'IBM Plex Mono', monospace; font-size: 11px; font-weight: 500; border: 1px solid; }

/* Past Days History Panel */
.past-days-toggle { margin-left: auto; padding: 5px 14px; background: transparent; border: 1px solid var(--border); color: var(--text-muted); border-radius: 3px; font-family: 'IBM Plex Mono', monospace; font-size: 10px; cursor: pointer; transition: all 0.2s; letter-spacing: 0.5px; white-space: nowrap; }
.past-days-toggle:hover { border-color: var(--gold-dim); color: var(--gold); }

.past-days-panel {
  display: none;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 16px 40px;
  overflow-x: auto;
}
.past-days-panel.open { display: block; animation: fadeUp 0.2s ease; }
.past-days-scroll { display: flex; gap: 8px; flex-wrap: wrap; }
.day-pill {
  display: flex; flex-direction: column; gap: 2px;
  padding: 8px 14px; border-radius: 5px; border: 1px solid var(--border);
  cursor: pointer; transition: all 0.18s; background: var(--bg);
  min-width: 100px; text-align: center;
}
.day-pill:hover { border-color: var(--gold-dim); background: var(--surface2); }
.day-pill.active-day { border-color: var(--gold); background: rgba(201,168,76,0.07); }
.day-pill.is-today { border-color: var(--blue); }
.day-pill-date { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: var(--text-dim); }
.day-pill-pnl { font-family: 'IBM Plex Mono', monospace; font-size: 13px; font-weight: 500; }
.day-pill-trades { font-family: 'IBM Plex Mono', monospace; font-size: 9px; color: var(--text-muted); }
.day-pill-status { font-size: 8px; font-family: 'IBM Plex Mono', monospace; color: var(--text-muted); letter-spacing: 0.5px; }
</style>
</head>
<body>

<header>
  <div class="logo">TradeEdge<span>Daily Journal</span></div>
  <div class="header-right">
    <div class="header-meta">
      <div id="currentDate"></div>
      <div id="currentTime" style="color:var(--text-dim)"></div>
    </div>
    <div class="pnl-badge neutral" id="headerPnl">‚Çπ0</div>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="sync-dot" id="syncDot"></div><span class="sync-label" id="syncLabel">Loading‚Ä¶</span>
    </div>
    <button class="data-btn" onclick="exportData()">‚¨á Export</button>
    <img class="user-avatar" id="userAvatar" src="" alt="" style="display:none" />
    <button class="sign-out-btn" onclick="signOut()">Sign Out</button>
    <div class="data-controls">
      <button class="data-btn" onclick="exportData()">‚¨á Export</button>
      <label class="data-btn" style="cursor:pointer;">‚¨Ü Import<input type="file" accept=".json" onchange="importData(event)" style="display:none"></label>
    </div>
  </div>
</header>

<!-- NAV -->
<div class="nav-tabs">
  <div class="nav-tab active" onclick="switchTab('journal')">üìã Journal</div>
  <div class="nav-tab" onclick="switchTab('analytics')">üìä Analytics</div>
</div>

<!-- STATUS BAR -->
<div class="status-bar">
  <div class="status-item"><div class="status-label">Today P&L</div><div class="status-value" id="statPnl">‚Çπ0.00</div></div>
  <div class="status-item"><div class="status-label">Trades Today</div><div class="status-value gold" id="statTrades">0</div></div>
  <div class="status-item"><div class="status-label">Win Rate</div><div class="status-value" id="statWin">‚Äî</div></div>
  <div class="status-item"><div class="status-label">Total Days</div><div class="status-value gold" id="statDays">‚Äî</div></div>
  <div class="status-item"><div class="status-label">All-Time P&L</div><div class="status-value" id="statAllTime">‚Çπ0</div></div>
  <div class="status-item"><div class="status-label">Target</div><div class="status-value gold">‚Çπ5,000</div></div>
  <div class="progress-section">
    <div class="progress-label"><span>Today's Progress</span><span id="progressPct">0%</span></div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
  </div>
  <button class="day-complete-btn" id="dayCompleteBtn" onclick="completeDay()">Mark Day Complete</button>
</div>

<!-- ‚îÄ‚îÄ ACTIVE DATE BAR ‚îÄ‚îÄ -->
<div class="active-date-bar">
  <div class="active-date-label">Viewing</div>
  <input type="date" class="date-picker-input" id="datePicker" onchange="onDatePicked(this.value)" />
  <button class="date-jump-btn today-btn" onclick="jumpToToday()">‚Üê Today</button>
  <div id="viewingPastBadge" class="viewing-past-badge" style="display:none">üìÖ Past Entry Mode</div>
  <div id="activeDatePnlPill" class="date-pnl-pill" style="display:none;border-color:var(--border);color:var(--text-muted)"></div>
  <button class="past-days-toggle" onclick="togglePastDays()" id="pastDaysToggleBtn">üìã All Days ‚ñæ</button>
</div>

<!-- ‚îÄ‚îÄ PAST DAYS PANEL ‚îÄ‚îÄ -->
<div class="past-days-panel" id="pastDaysPanel">
  <div class="past-days-scroll" id="pastDaysScroll"></div>
</div>

<!-- ‚ïê‚ïê JOURNAL PAGE ‚ïê‚ïê -->
<div id="page-journal" class="page active">
  <div class="journal-layout">
    <div class="left-panel">
      <div class="force-stop-banner" id="forceStopBanner">üõë FORCE STOP ‚Äî Target hit. No more trades today. Protect your gains.</div>

      <div class="section-title">Log New Trade</div>
      <div class="trade-form">
        <div class="form-grid">
          <div class="form-group"><label>Symbol</label><input type="text" id="fSymbol" placeholder="NIFTY, BANKNIFTY‚Ä¶"/></div>
          <div class="form-group"><label>Direction</label><select id="fDir"><option value="long">LONG</option><option value="short">SHORT</option></select></div>
          <div class="form-group"><label>Timeframe</label><select id="fTf"><option value="5m">5 min</option><option value="10m">10 min</option><option value="15m">15 min</option></select></div>
          <div class="form-group"><label>Entry ‚Çπ</label><input type="number" id="fEntry" placeholder="0.00"/></div>
          <div class="form-group"><label>Exit ‚Çπ</label><input type="number" id="fExit" placeholder="0.00"/></div>
          <div class="form-group"><label>Qty / Lots</label><input type="number" id="fQty" placeholder="1"/></div>
        </div>

        <div style="margin-bottom:8px;font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);font-family:'IBM Plex Mono',monospace;">Pre-Trade Analysis Checklist</div>
        <div class="checklist-row">
          <label class="check-item" onclick="toggleCheck(this)"><input type="checkbox"/><div class="check-dot">‚úì</div><span class="check-text">5/10 Min Chart</span></label>
          <label class="check-item" onclick="toggleCheck(this)"><input type="checkbox"/><div class="check-dot">‚úì</div><span class="check-text">Buy/Sell Area</span></label>
          <label class="check-item" onclick="toggleCheck(this)"><input type="checkbox"/><div class="check-dot">‚úì</div><span class="check-text">FVG Retest</span></label>
        </div>

        <div style="margin-bottom:8px;font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);font-family:'IBM Plex Mono',monospace;">Trade Behaviour Tags</div>
        <div class="flag-row">
          <div class="flag-chip delayed-sl" onclick="toggleFlag(this)">‚è± Delayed SL</div>
          <div class="flag-chip revenge" onclick="toggleFlag(this)">üî• Revenge Trade</div>
          <div class="flag-chip risky" onclick="toggleFlag(this)">‚ö° Risky Setup</div>
          <div class="flag-chip fomo" onclick="toggleFlag(this)">üò∞ FOMO Entry</div>
          <div class="flag-chip disciplined" onclick="toggleFlag(this)">‚úÖ Disciplined</div>
        </div>
        <div class="form-group" style="margin-bottom:14px;"><label>Notes</label><textarea id="fNotes" rows="2" placeholder="Market context, emotions, setup rationale‚Ä¶" style="resize:vertical;"></textarea></div>
        <div class="form-actions">
          <button class="btn-secondary" onclick="clearForm()">Clear</button>
          <button class="btn-primary" onclick="logTrade()">Log Trade ‚Üí</button>
        </div>
      </div>

      <div class="section-title" id="tradeLogTitle">Today's Trades</div>
      <div class="log-header"><span>Symbol</span><span>Dir</span><span>Entry</span><span>Exit</span><span>P&L</span><span>TF</span><span>Flags / Checklist</span><span>Notes</span></div>
      <div id="tradeLog"></div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="right-panel">
      <div class="mindful-section">
        <div class="section-title" style="font-size:10px;margin-bottom:14px;">Mental Edge</div>
        <div class="quote-card">
          <div class="quote-text" id="quoteText"></div>
          <div class="quote-author" id="quoteAuthor"></div>
          <div class="quote-nav">
            <button class="quote-btn" onclick="prevQuote()">‚Üê Prev</button>
            <button class="quote-btn" onclick="nextQuote()">Next ‚Üí</button>
          </div>
        </div>
        <div class="breathing-widget">
          <div style="font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);font-family:'IBM Plex Mono',monospace;margin-bottom:12px;">Box Breathing ‚Äî 4¬∑4¬∑6</div>
          <div class="breath-ring"><div class="breath-ring-fill" id="breathRing"></div></div>
          <div class="breath-label" id="breathLabel">Ready</div>
          <div class="breath-instruction" id="breathInstruction">4 inhale ¬∑ 4 hold ¬∑ 6 exhale</div>
          <button class="breath-btn" id="breathBtn" onclick="toggleBreath()">Start</button>
        </div>
      </div>
      <div class="suggestions-section">
        <div class="section-title" style="font-size:10px;margin-bottom:14px;">Journal Insights</div>
        <div id="suggestions"></div>
      </div>
      <div class="stats-section">
        <div class="section-title" style="font-size:10px;margin-bottom:14px;">Session Stats</div>
        <div class="stats-grid">
          <div class="stat-box"><div class="stat-box-label">Best Trade</div><div class="stat-box-value green" id="bestTrade">‚Äî</div></div>
          <div class="stat-box"><div class="stat-box-label">Worst Trade</div><div class="stat-box-value red" id="worstTrade">‚Äî</div></div>
          <div class="stat-box"><div class="stat-box-label">Avg Winner</div><div class="stat-box-value" id="avgWinner">‚Äî</div></div>
          <div class="stat-box"><div class="stat-box-label">Avg Loser</div><div class="stat-box-value" id="avgLoser">‚Äî</div></div>
          <div class="stat-box"><div class="stat-box-label">Checklist %</div><div class="stat-box-value gold" id="checkScore">‚Äî</div></div>
          <div class="stat-box"><div class="stat-box-label">Discipline</div><div class="stat-box-value" id="disciplineScore">‚Äî</div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê ANALYTICS PAGE ‚ïê‚ïê -->
<div id="page-analytics" class="page">
  <div class="analytics-page">
    <div class="analytics-header">
      <div>
        <div class="analytics-title">Performance <span>Analytics</span></div>
        <div class="analytics-subtitle">vs Nifty 50 & Nifty 500 ‚Äî % Return Normalised</div>
      </div>
      <div class="nifty-status">
        <div class="nifty-badge">
          <div class="nifty-badge-label" style="color:var(--nifty50-color)">Nifty 50</div>
          <div class="nifty-badge-value" id="n50Value">‚Äî</div>
          <div class="nifty-badge-label" id="n50Change" style="font-size:9px;margin-top:2px;"></div>
        </div>
        <div class="nifty-badge">
          <div class="nifty-badge-label" style="color:var(--nifty500-color)">Nifty 500</div>
          <div class="nifty-badge-value" id="n500Value">‚Äî</div>
          <div class="nifty-badge-label" id="n500Change" style="font-size:9px;margin-top:2px;"></div>
        </div>
        <div class="nifty-status-text" id="niftyFetchStatus">Fetching index data‚Ä¶</div>
      </div>
    </div>

    <!-- KPI STRIP -->
    <div class="kpi-strip" id="kpiStrip">
      <div class="kpi-card"><div class="kpi-label">Total P&L</div><div class="kpi-value" id="kTotal">‚Çπ0</div><div class="kpi-sub" id="kTotalSub">0 trading days</div></div>
      <div class="kpi-card"><div class="kpi-label">Win Rate</div><div class="kpi-value" id="kWin">‚Äî</div><div class="kpi-sub" id="kWinSub">wins / total</div></div>
      <div class="kpi-card"><div class="kpi-label">Best Day</div><div class="kpi-value green" id="kBestDay">‚Äî</div><div class="kpi-sub" id="kBestDayDate">‚Äî</div></div>
      <div class="kpi-card"><div class="kpi-label">Worst Day</div><div class="kpi-value red" id="kWorstDay">‚Äî</div><div class="kpi-sub" id="kWorstDayDate">‚Äî</div></div>
      <div class="kpi-card"><div class="kpi-label">Avg Day P&L</div><div class="kpi-value" id="kAvgDay">‚Äî</div><div class="kpi-sub">per session</div></div>
      <div class="kpi-card"><div class="kpi-label">Profit Days</div><div class="kpi-value gold" id="kProfitDays">‚Äî</div><div class="kpi-sub">of total days</div></div>
    </div>

    <!-- CHART 1: Yearly Cumulative + Nifty Comparison -->
    <div class="charts-grid">
      <div class="chart-card full">
        <div class="chart-title">Cumulative % Return vs Nifty Indices</div>
        <div class="chart-subtitle">Normalised to starting capital ‚Äî compares your trading returns against market performance</div>
        <div class="chart-legend">
          <div class="legend-item"><div class="legend-dot" style="background:var(--trader-color)"></div>Your P&L %</div>
          <div class="legend-item"><div class="legend-dot" style="background:var(--nifty50-color)"></div>Nifty 50</div>
          <div class="legend-item"><div class="legend-dot" style="background:var(--nifty500-color)"></div>Nifty 500</div>
        </div>
        <div id="noDataYearly" class="no-data-msg" style="display:none"><div class="big">üìà</div>Start logging trades to see your cumulative return chart here.</div>
        <canvas id="yearlyChart" height="260"></canvas>
      </div>

      <!-- CHART 2: Monthly P&L -->
      <div class="chart-card">
        <div class="chart-title">Monthly P&L</div>
        <div class="chart-subtitle">Net profit/loss per calendar month</div>
        <div id="noDataMonthly" class="no-data-msg" style="display:none;padding:40px"><div class="big" style="font-size:24px">üìÖ</div>No data yet.</div>
        <canvas id="monthlyChart" height="240"></canvas>
      </div>

      <!-- CHART 3: Weekly P&L -->
      <div class="chart-card">
        <div class="chart-title">Weekly P&L</div>
        <div class="chart-subtitle">Net profit/loss per week (last 12 weeks)</div>
        <div id="noDataWeekly" class="no-data-msg" style="display:none;padding:40px"><div class="big" style="font-size:24px">üìÜ</div>No data yet.</div>
        <canvas id="weeklyChart" height="240"></canvas>
      </div>
    </div>

    <!-- Behaviour Analysis -->
    <div class="chart-card" style="margin-bottom:20px;">
      <div class="chart-title">Behaviour Impact Analysis</div>
      <div class="chart-subtitle">How each behaviour tag correlates with your P&L outcomes</div>
      <div class="behaviour-grid" id="behaviourGrid">
        <div style="text-align:center;padding:24px;color:var(--text-muted);font-family:'IBM Plex Mono',monospace;font-size:11px;grid-column:1/-1;">Log trades with behaviour tags to see analysis here.</div>
      </div>
    </div>

    <!-- Checklist Compliance -->
    <div class="chart-card" style="margin-bottom:32px;">
      <div class="chart-title">Pre-Trade Checklist Compliance</div>
      <div class="chart-subtitle">% of trades where each analysis step was followed</div>
      <div id="noDataChecklist" class="no-data-msg" style="display:none;padding:30px"><div class="big" style="font-size:24px">‚úÖ</div>No data.</div>
      <canvas id="checklistChart" height="140"></canvas>
    </div>
  </div>
</div>

<!-- DAY COMPLETE OVERLAY -->
<div class="overlay" id="overlay">
  <div class="overlay-eyebrow">Session Complete</div>
  <div class="overlay-title">Well Traded.</div>
  <div class="overlay-pnl" id="overlayPnl"></div>
  <div class="overlay-msg" id="overlayMsg"></div>
  <button class="overlay-close" onclick="closeOverlay()">Review Journal</button>
</div>


<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIGURATION ‚Äî FILL THESE IN AFTER SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CONFIG = {
  GOOGLE_CLIENT_ID: '125105345754-91nt9ufd62h7q5cjcft9q5t4mq79ea0d.apps.googleusercontent.com',
  APPS_SCRIPT_URL:  'https://script.google.com/u/0/home/projects/1Acpp7SgF7hyXYioRe13CA6bffM6P5CQldGhCSGSCMcXVcxpgg3awdwtz/edit',
  STARTING_CAPITAL: 100000,
  TARGET:           5000,
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentUser = null;  // { email, name, picture, credential }

function handleGoogleSignIn(response) {
  // Decode JWT payload (no verification needed ‚Äî Apps Script verifies server-side)
  const payload = JSON.parse(atob(response.credential.split('.')[1]));
  currentUser = {
    email: payload.email,
    name: payload.name,
    picture: payload.picture,
    credential: response.credential
  };

  // Show avatar
  const avatar = document.getElementById('userAvatar');
  avatar.src = currentUser.picture;
  avatar.style.display = 'block';
  avatar.title = currentUser.name + ' (' + currentUser.email + ')';

  // Hide login, show app
  document.getElementById('loginScreen').classList.add('hidden');
  startApp();
}

function signOut() {
  google.accounts.id.disableAutoSelect();
  currentUser = null;
  state = { days: {}, nifty50: [], nifty500: [] };
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('userAvatar').style.display = 'none';
  setSyncStatus('idle');
}

function initGoogleSignIn() {
  google.accounts.id.initialize({
    client_id: CONFIG.GOOGLE_CLIENT_ID,
    callback: handleGoogleSignIn,
    auto_select: true,         // silently signs in if previously authenticated
    cancel_on_tap_outside: false,
  });
  google.accounts.id.renderButton(
    document.getElementById('g_id_signin'),
    { theme: 'filled_black', size: 'large', text: 'signin_with', shape: 'rectangular', width: 280 }
  );
  google.accounts.id.prompt(); // triggers One Tap if session exists
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SYNC STATUS UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setSyncStatus(status, msg) {
  const dot = document.getElementById('syncDot');
  const label = document.getElementById('syncLabel');
  dot.className = 'sync-dot';
  if (status === 'syncing') { dot.classList.add('syncing'); label.textContent = msg || 'Saving‚Ä¶'; }
  else if (status === 'synced') { dot.classList.add('synced'); label.textContent = msg || 'Saved'; }
  else if (status === 'error') { dot.classList.add('error'); label.textContent = msg || 'Sync error'; }
  else { label.textContent = msg || ''; }
}

function showLoading(msg) {
  document.getElementById('loadingText').textContent = msg || 'Loading‚Ä¶';
  document.getElementById('loadingOverlay').classList.remove('hidden');
}
function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  APPS SCRIPT API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function apiGet(action, params = {}) {
  const url = new URL(CONFIG.APPS_SCRIPT_URL);
  url.searchParams.set('action', action);
  url.searchParams.set('email', currentUser.email);
  Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
  const r = await fetch(url.toString());
  if (!r.ok) throw new Error('API error ' + r.status);
  return r.json();
}

async function apiPost(payload) {
  const r = await fetch(CONFIG.APPS_SCRIPT_URL, {
    method: 'POST',
    body: JSON.stringify({ ...payload, email: currentUser.email }),
  });
  if (!r.ok) throw new Error('API error ' + r.status);
  return r.json();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let state = { days: {}, nifty50: [], nifty500: [] };
let activeDate = new Date().toISOString().slice(0,10);
const TARGET = CONFIG.TARGET;
const STARTING_CAPITAL = CONFIG.STARTING_CAPITAL;

function today() { return new Date().toISOString().slice(0,10); }
function isToday() { return activeDate === today(); }

function activeDayData() {
  if (!state.days[activeDate]) state.days[activeDate] = { trades:[], completed:false };
  return state.days[activeDate];
}
function dayPnl(d) { return (d.trades||[]).reduce((s,t)=>s+t.pnl,0); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SAVE OPERATIONS (write to Sheets)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function persistTrade(trade) {
  setSyncStatus('syncing');
  try {
    await apiPost({ action:'saveTrade', date:activeDate, trade });
    setSyncStatus('synced', 'Saved ‚úì');
    setTimeout(()=>setSyncStatus('idle',''), 2000);
  } catch(e) {
    setSyncStatus('error', 'Save failed ‚Äî retrying‚Ä¶');
    setTimeout(()=>persistTrade(trade), 4000);
  }
}

async function persistDeleteTrade(tradeId) {
  setSyncStatus('syncing');
  try {
    await apiPost({ action:'deleteTrade', date:activeDate, tradeId });
    setSyncStatus('synced', 'Deleted ‚úì');
    setTimeout(()=>setSyncStatus('idle',''), 2000);
  } catch(e) {
    setSyncStatus('error', 'Delete failed');
  }
}

async function persistDayComplete(completed) {
  setSyncStatus('syncing');
  try {
    await apiPost({ action:'markDayComplete', date:activeDate, completed });
    setSyncStatus('synced', 'Saved ‚úì');
    setTimeout(()=>setSyncStatus('idle',''), 2000);
  } catch(e) {
    setSyncStatus('error', 'Save failed');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOAD ALL DATA FROM SHEETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadAllData() {
  showLoading('Loading your trade history‚Ä¶');
  try {
    const res = await apiGet('getAllDays');
    if (res.success) {
      state.days = res.days || {};
    }
  } catch(e) {
    console.warn('Load error:', e);
    setSyncStatus('error', 'Could not load data');
  } finally {
    hideLoading();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXPORT (JSON backup)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportData() {
  const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `tradeedge-backup-${today()}.json`;
  a.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  QUOTES & BREATHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const QUOTES = [
  { text:"The goal of a successful trader is to make the best trades. Money is secondary.", author:"Alexander Elder" },
  { text:"It's not whether you're right or wrong that's important, but how much money you make when you're right.", author:"George Soros" },
  { text:"In trading, the one who knows when to sit tight is right.", author:"Jesse Livermore" },
  { text:"Do not anticipate and move without market confirmation ‚Äî being a little late in your trade is your insurance.", author:"Jesse Livermore" },
  { text:"The elements of good trading are: cutting losses, cutting losses, and cutting losses.", author:"Ed Seykota" },
  { text:"A peak performance trader is totally focused on the present moment regardless of what happened yesterday.", author:"Mark Douglas" },
  { text:"When in doubt, stay out.", author:"Trading Proverb" },
  { text:"Risk comes from not knowing what you are doing.", author:"Warren Buffett" },
  { text:"The most important quality for an investor is temperament, not intellect.", author:"Warren Buffett" },
  { text:"Trade what you see, not what you think.", author:"Linda Bradford Raschke" },
];
let qIdx = 0;
function showQuote(i) {
  document.getElementById('quoteText').textContent = QUOTES[i].text;
  document.getElementById('quoteAuthor').textContent = '‚Äî ' + QUOTES[i].author;
}
function nextQuote() { qIdx = (qIdx+1)%QUOTES.length; showQuote(qIdx); }
function prevQuote() { qIdx = (qIdx-1+QUOTES.length)%QUOTES.length; showQuote(qIdx); }

let breathingActive=false, breathTimeout=null;
function toggleBreath() {
  if (breathingActive) {
    breathingActive=false; clearTimeout(breathTimeout);
    document.getElementById('breathBtn').textContent='Start';
    document.getElementById('breathLabel').textContent='Ready';
    document.getElementById('breathInstruction').textContent='4 inhale ¬∑ 4 hold ¬∑ 6 exhale';
    document.getElementById('breathRing').className='breath-ring-fill';
  } else { breathingActive=true; document.getElementById('breathBtn').textContent='Stop'; runBreathCycle(); }
}
function runBreathCycle() {
  if (!breathingActive) return;
  const ring=document.getElementById('breathRing');
  document.getElementById('breathLabel').textContent='Inhale';
  document.getElementById('breathInstruction').textContent='breathe in slowly‚Ä¶';
  ring.className='breath-ring-fill inhale';
  breathTimeout=setTimeout(()=>{
    if(!breathingActive)return;
    document.getElementById('breathLabel').textContent='Hold';
    document.getElementById('breathInstruction').textContent='hold your breath‚Ä¶';
    ring.className='breath-ring-fill hold';
    breathTimeout=setTimeout(()=>{
      if(!breathingActive)return;
      document.getElementById('breathLabel').textContent='Exhale';
      document.getElementById('breathInstruction').textContent='release slowly‚Ä¶';
      ring.className='breath-ring-fill exhale';
      breathTimeout=setTimeout(()=>{ if(breathingActive) runBreathCycle(); },6000);
    },4000);
  },4000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATE NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setActiveDate(date) {
  activeDate = date;
  document.getElementById('datePicker').value = date;
  const isPast = !isToday();
  document.getElementById('viewingPastBadge').style.display = isPast ? 'flex' : 'none';
  document.getElementById('dayCompleteBtn').style.display = isPast ? 'none' : '';
  const d = state.days[date];
  const pill = document.getElementById('activeDatePnlPill');
  if (d && d.trades && d.trades.length) {
    const p = dayPnl(d);
    pill.style.display = 'flex';
    pill.textContent = `${p>=0?'+':''}‚Çπ${p.toLocaleString('en-IN')} ¬∑ ${d.trades.length} trade${d.trades.length!==1?'s':''}`;
    pill.style.borderColor = p>=0?'var(--green)':'var(--red)';
    pill.style.color = p>=0?'var(--green)':'var(--red)';
  } else { pill.style.display='none'; }
  const titleEl=document.getElementById('tradeLogTitle');
  if(titleEl) titleEl.textContent = isToday() ? "Today's Trades" : `Trades ‚Äî ${formatDateNice(date)}`;
  const banner=document.getElementById('forceStopBanner');
  if(isPast){banner.classList.remove('show');} else {checkForceStop();}
  renderTrades(); updateStats(); generateSuggestions(); refreshPastDaysPanel();
}
function jumpToToday() { setActiveDate(today()); }
function onDatePicked(val) {
  if(!val) return;
  if(val>today()){alert("You can't log trades for a future date."); document.getElementById('datePicker').value=activeDate; return;}
  setActiveDate(val);
}
function togglePastDays() {
  const panel=document.getElementById('pastDaysPanel');
  const btn=document.getElementById('pastDaysToggleBtn');
  const isOpen=panel.classList.toggle('open');
  btn.textContent=isOpen?'üìã All Days ‚ñ¥':'üìã All Days ‚ñæ';
  if(isOpen) refreshPastDaysPanel();
}
function refreshPastDaysPanel() {
  const scroll=document.getElementById('pastDaysScroll');
  const allDays=Object.keys(state.days).sort().reverse();
  if(!allDays.length){scroll.innerHTML=`<div style="font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--text-muted);padding:8px 0;">No trading days logged yet.</div>`;return;}
  scroll.innerHTML=allDays.map(d=>{
    const data=state.days[d]; const p=dayPnl(data);
    const pColor=p>0?'var(--green)':p<0?'var(--red)':'var(--text-muted)';
    const pSign=p>0?'+':''; const isActive=d===activeDate; const isTod=d===today();
    return `<div class="day-pill ${isActive?'active-day':''} ${isTod?'is-today':''}" onclick="setActiveDate('${d}'); togglePastDays()">
      <div class="day-pill-date">${isTod?'TODAY':d.slice(5)}</div>
      <div class="day-pill-pnl" style="color:${pColor}">${pSign}‚Çπ${Math.abs(p).toLocaleString('en-IN')}</div>
      <div class="day-pill-trades">${(data.trades||[]).length} trade${(data.trades||[]).length!==1?'s':''}</div>
      <div class="day-pill-status">${data.completed?'‚úì complete':isTod?'active':'‚Äî'}</div>
    </div>`;
  }).join('');
}
function formatDateNice(dateStr) {
  return new Date(dateStr+'T00:00:00').toLocaleDateString('en-IN',{weekday:'short',day:'2-digit',month:'short',year:'numeric'});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(tab) {
  document.querySelectorAll('.nav-tab').forEach((t,i)=>t.classList.toggle('active',['journal','analytics'][i]===tab));
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+tab).classList.add('active');
  if(tab==='analytics'){buildAnalytics();}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FORM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleCheck(el){el.classList.toggle('checked');el.querySelector('input').checked=el.classList.contains('checked');}
function toggleFlag(el){el.classList.toggle('active');}
function clearForm(){
  ['fSymbol','fEntry','fExit','fQty','fNotes'].forEach(id=>document.getElementById(id).value='');
  document.querySelectorAll('.check-item').forEach(c=>c.classList.remove('checked'));
  document.querySelectorAll('.flag-chip').forEach(f=>f.classList.remove('active'));
}

async function logTrade() {
  if(activeDayData().completed){alert('This day is marked complete.');return;}
  const symbol=document.getElementById('fSymbol').value.trim().toUpperCase();
  const dir=document.getElementById('fDir').value;
  const tf=document.getElementById('fTf').value;
  const entry=parseFloat(document.getElementById('fEntry').value);
  const exit=parseFloat(document.getElementById('fExit').value);
  const qty=parseFloat(document.getElementById('fQty').value)||1;
  const notes=document.getElementById('fNotes').value.trim();
  if(!symbol||isNaN(entry)||isNaN(exit)){alert('Please fill in Symbol, Entry and Exit.');return;}
  const checks=[...document.querySelectorAll('.check-item')].map(c=>c.classList.contains('checked'));
  const flags=[...document.querySelectorAll('.flag-chip.active')].map(f=>f.textContent.trim());
  const pnl=parseFloat(((exit-entry)*qty*(dir==='short'?-1:1)).toFixed(2));
  const trade={id:Date.now(),symbol,dir,tf,entry,exit,qty,pnl,checks,flags,notes,time:new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})};
  activeDayData().trades.push(trade);
  renderTrades(); updateStats(); generateSuggestions(); clearForm();
  if(isToday()) checkForceStop();
  refreshPastDaysPanel(); setActiveDate(activeDate);
  // async persist to Sheets
  await persistTrade(trade);
}

async function deleteTrade(id) {
  activeDayData().trades=activeDayData().trades.filter(t=>t.id!==id);
  renderTrades(); updateStats(); generateSuggestions(); refreshPastDaysPanel(); setActiveDate(activeDate);
  await persistDeleteTrade(id);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER TRADES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTrades() {
  const log=document.getElementById('tradeLog');
  const trades=activeDayData().trades;
  const isPast=!isToday();
  if(!trades.length){
    log.innerHTML=`<div class="empty-state"><div class="icon">üìã</div>${isPast?`No trades logged for ${formatDateNice(activeDate)}.`:'No trades logged today. Add your first trade above.'}</div>`;
    return;
  }
  log.innerHTML=[...trades].reverse().map(t=>{
    const pnlCls=t.pnl>=0?'pos':'neg'; const pnlSign=t.pnl>=0?'+':'';
    const flagHtml=t.flags.map(f=>{
      let cls='mf-disciplined';
      if(f.includes('Delayed'))cls='mf-delayed';
      else if(f.includes('Revenge'))cls='mf-revenge';
      else if(f.includes('Risky'))cls='mf-risky';
      else if(f.includes('FOMO'))cls='mf-fomo';
      return `<span class="mini-flag ${cls}">${f.replace(/[üî•‚è±‚ö°üò∞‚úÖ]/g,'').trim()}</span>`;
    }).join('');
    const ciHtml=['üìä','üìç','üîç'].map((ic,i)=>`<span class="ci ${t.checks[i]?'ok':''}" title="${['Chart TF','Buy/Sell','FVG Retest'][i]}">${ic}</span>`).join('');
    return `<div class="trade-row">
      <span class="trade-symbol">${t.symbol}</span>
      <span class="trade-dir ${t.dir}">${t.dir.toUpperCase()}</span>
      <span class="trade-col">‚Çπ${t.entry}</span>
      <span class="trade-col">‚Çπ${t.exit}</span>
      <span class="trade-pnl ${pnlCls}">${pnlSign}‚Çπ${Math.abs(t.pnl).toLocaleString('en-IN')}</span>
      <span class="trade-col">${t.tf}</span>
      <div><div class="trade-flags">${flagHtml}</div><div style="display:flex;gap:3px;margin-top:3px">${ciHtml}</div></div>
      <div style="display:flex;align-items:center;gap:6px;overflow:hidden;">
        <span class="trade-col" style="font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1" title="${t.notes}">${t.notes||'‚Äî'}</span>
        <button class="delete-trade" onclick="deleteTrade(${t.id})" title="Delete">‚úï</button>
      </div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateStats() {
  const trades=activeDayData().trades;
  const pnl=trades.reduce((s,t)=>s+t.pnl,0);
  const wins=trades.filter(t=>t.pnl>0),losses=trades.filter(t=>t.pnl<0);
  const wr=trades.length?Math.round((wins.length/trades.length)*100):null;
  document.getElementById('statPnl').textContent=`‚Çπ${pnl.toLocaleString('en-IN',{minimumFractionDigits:2})}`;
  document.getElementById('statPnl').className=`status-value ${pnl>0?'green':pnl<0?'red':''}`;
  document.getElementById('statTrades').textContent=trades.length;
  document.getElementById('statWin').textContent=wr!==null?`${wr}%`:'‚Äî';
  document.getElementById('statWin').className=`status-value ${wr>=50?'green':'red'}`;
  const allDays=Object.keys(state.days);
  document.getElementById('statDays').textContent=allDays.length;
  const allPnl=Object.values(state.days).reduce((s,d)=>s+dayPnl(d),0);
  const apEl=document.getElementById('statAllTime');
  apEl.textContent=`‚Çπ${allPnl.toLocaleString('en-IN',{minimumFractionDigits:0})}`;
  apEl.className=`status-value ${allPnl>0?'green':allPnl<0?'red':''}`;
  const pct=Math.min(100,Math.max(0,(pnl/TARGET)*100));
  document.getElementById('progressFill').style.width=pct+'%';
  document.getElementById('progressPct').textContent=Math.round(pct)+'%';
  const hPnl=document.getElementById('headerPnl');
  hPnl.textContent=`‚Çπ${pnl>=0?'+':''}${pnl.toLocaleString('en-IN',{minimumFractionDigits:0})}`;
  hPnl.className=`pnl-badge ${pnl>0?'profit':pnl<0?'loss':'neutral'}`;
  const bestPnl=wins.length?Math.max(...wins.map(t=>t.pnl)):null;
  const worstPnl=losses.length?Math.min(...losses.map(t=>t.pnl)):null;
  const avgW=wins.length?wins.reduce((s,t)=>s+t.pnl,0)/wins.length:null;
  const avgL=losses.length?losses.reduce((s,t)=>s+t.pnl,0)/losses.length:null;
  document.getElementById('bestTrade').textContent=bestPnl?`+‚Çπ${bestPnl.toLocaleString('en-IN')}`:'‚Äî';
  document.getElementById('worstTrade').textContent=worstPnl?`‚Çπ${worstPnl.toLocaleString('en-IN')}`:'‚Äî';
  document.getElementById('avgWinner').textContent=avgW?`+‚Çπ${avgW.toFixed(0)}`:'‚Äî';
  document.getElementById('avgLoser').textContent=avgL?`‚Çπ${avgL.toFixed(0)}`:'‚Äî';
  if(trades.length){const tc=trades.reduce((s,t)=>s+t.checks.filter(Boolean).length,0);document.getElementById('checkScore').textContent=Math.round((tc/(trades.length*3))*100)+'%';}
  else{document.getElementById('checkScore').textContent='‚Äî';}
  const badFlags=trades.reduce((s,t)=>s+t.flags.filter(f=>!f.includes('‚úÖ')).length,0);
  const discFlags=trades.reduce((s,t)=>s+t.flags.filter(f=>f.includes('‚úÖ')).length,0);
  document.getElementById('disciplineScore').textContent=trades.length?`${discFlags}‚úÖ ${badFlags}‚ö†Ô∏è`:'‚Äî';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUGGESTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generateSuggestions() {
  const trades=activeDayData().trades;
  const pnl=trades.reduce((s,t)=>s+t.pnl,0);
  const wins=trades.filter(t=>t.pnl>0),losses=trades.filter(t=>t.pnl<0);
  const hasDelayed=trades.some(t=>t.flags.some(f=>f.includes('Delayed')));
  const hasRevenge=trades.some(t=>t.flags.some(f=>f.includes('Revenge')));
  const hasRisky=trades.some(t=>t.flags.some(f=>f.includes('Risky')));
  const recentLoss=[...trades].slice(-3).filter(t=>t.pnl<0).length;
  const checkPct=trades.length?trades.reduce((s,t)=>s+t.checks.filter(Boolean).length,0)/(trades.length*3):1;
  let cards=[];
  if(pnl>=TARGET) cards.push({type:'positive',label:'üéØ Target Reached',text:`You've hit ‚Çπ${TARGET.toLocaleString('en-IN')}. Activate Force Stop ‚Äî no more trades today.`});
  if(hasDelayed) cards.push({type:'warning',label:'‚è± Delayed SL Detected',text:'Pre-define your SL before entry and honour it immediately. Delayed SL is one of the top profit killers in intraday trading.'});
  if(hasRevenge) cards.push({type:'danger',label:'üî• Revenge Trading Alert',text:'Step away for 10 minutes. Use the breathing exercise. Revenge trades are emotionally-driven, not analysis-driven.'});
  if(recentLoss>=2) cards.push({type:'danger',label:'üìâ Consecutive Losses',text:`${recentLoss} of your last 3 trades are losses. Consider a short break to reset.`});
  if(checkPct<0.6&&trades.length>0) cards.push({type:'warning',label:'üìã Low Checklist Compliance',text:'Less than 60% of your trades followed the full pre-trade checklist.'});
  if(wins.length>0&&losses.length>0){
    const avgW=wins.reduce((s,t)=>s+t.pnl,0)/wins.length;
    const avgL=Math.abs(losses.reduce((s,t)=>s+t.pnl,0)/losses.length);
    const rr=avgW/avgL;
    if(rr<1) cards.push({type:'warning',label:'‚öñÔ∏è Reward:Risk Below 1:1',text:`Avg winner ‚Çπ${avgW.toFixed(0)} vs avg loser ‚Çπ${avgL.toFixed(0)}. Let winners run further.`});
    else cards.push({type:'positive',label:'‚öñÔ∏è Solid R:R Ratio',text:`Your R:R is ${rr.toFixed(2)}:1 today. Keep cutting losers and letting winners breathe.`});
  }
  if(hasRisky) cards.push({type:'info',label:'‚ö° Risky Setup Logged',text:'Track risky setups over time in Analytics. The data will tell you the truth.'});
  if(!cards.length&&trades.length>0) cards.push({type:'info',label:'üìä Clean Session So Far',text:'No red flags detected. Keep following your checklist and honouring your SL.'});
  if(!trades.length) cards.push({type:'info',label:'üìä Getting Started',text:'Log your first trade to see personalised insights based on your behaviour patterns.'});
  document.getElementById('suggestions').innerHTML=cards.map(c=>`<div class="suggestion-card ${c.type}"><div class="suggestion-label">${c.label}</div>${c.text}</div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FORCE STOP / DAY COMPLETE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkForceStop() {
  const pnl=activeDayData().trades.reduce((s,t)=>s+t.pnl,0);
  if(pnl>=TARGET) document.getElementById('forceStopBanner').classList.add('show');
}

async function completeDay() {
  activeDayData().completed=true;
  document.getElementById('dayCompleteBtn').classList.add('done');
  document.getElementById('dayCompleteBtn').textContent='‚úì Day Complete';
  const trades=activeDayData().trades;
  const pnl=trades.reduce((s,t)=>s+t.pnl,0);
  const wins=trades.filter(t=>t.pnl>0);
  const wr=trades.length?Math.round((wins.length/trades.length)*100):0;
  document.getElementById('overlayPnl').textContent=`${pnl>=0?'+':''}‚Çπ${pnl.toLocaleString('en-IN',{minimumFractionDigits:2})}`;
  document.getElementById('overlayPnl').style.color=pnl>=0?'var(--green)':'var(--red)';
  const hasIssues=trades.some(t=>t.flags.some(f=>f.includes('Revenge')||f.includes('Delayed')));
  if(pnl>=TARGET) document.getElementById('overlayMsg').textContent=`Target achieved in ${trades.length} trades (${wr}% win rate). Force Stop was the right call ‚Äî protect your gains.`;
  else if(pnl>0) document.getElementById('overlayMsg').textContent=`Profitable day ‚Äî ‚Çπ${pnl.toFixed(0)} with ${wr}% win rate. ${hasIssues?'Review the flagged trades tomorrow.':'Clean execution today.'}`;
  else document.getElementById('overlayMsg').textContent=`Loss day of ‚Çπ${Math.abs(pnl).toFixed(0)}. Review flagged trades. Losing days are part of the game ‚Äî what matters is the lesson.`;
  document.getElementById('overlay').classList.add('show');
  await persistDayComplete(true);
}
function closeOverlay(){document.getElementById('overlay').classList.remove('show');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NIFTY DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchNiftyData() {
  const status=document.getElementById('niftyFetchStatus');
  try {
    const fetchTicker=async(ticker)=>{
      const url=`https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(ticker)}?range=1y&interval=1d`;
      const r=await fetch(url);
      if(!r.ok) throw new Error('fetch failed');
      const json=await r.json();
      const ts=json.chart.result[0].timestamp;
      const closes=json.chart.result[0].indicators.quote[0].close;
      return ts.map((t,i)=>({date:new Date(t*1000).toISOString().slice(0,10),close:closes[i]})).filter(d=>d.close!=null);
    };
    const [n50,n500]=await Promise.all([fetchTicker('^NSEI'),fetchTicker('^CRSLDX')]);
    state.nifty50=n50; state.nifty500=n500;
    if(n50.length){
      const last=n50[n50.length-1],prev=n50[n50.length-2];
      const chg=prev?((last.close-prev.close)/prev.close*100).toFixed(2):'‚Äî';
      document.getElementById('n50Value').textContent=last.close.toFixed(0);
      document.getElementById('n50Change').textContent=`${chg>0?'+':''}${chg}% today`;
      document.getElementById('n50Change').style.color=chg>=0?'var(--green)':'var(--red)';
    }
    if(n500.length){
      const last=n500[n500.length-1],prev=n500[n500.length-2];
      const chg=prev?((last.close-prev.close)/prev.close*100).toFixed(2):'‚Äî';
      document.getElementById('n500Value').textContent=last.close.toFixed(0);
      document.getElementById('n500Change').textContent=`${chg>0?'+':''}${chg}% today`;
      document.getElementById('n500Change').style.color=chg>=0?'var(--green)':'var(--red)';
    }
    status.textContent=`Updated ${new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})}`;
    status.style.color='var(--green)';
  } catch(e){
    status.textContent='Index data unavailable'; status.style.color='var(--orange)';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ANALYTICS (identical to v2)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let charts={};
function destroyChart(id){if(charts[id]){charts[id].destroy();delete charts[id];}}
function getChartDefaults(){
  return{responsive:true,maintainAspectRatio:true,
    plugins:{legend:{display:false},tooltip:{backgroundColor:'#18181c',borderColor:'#2a2a2f',borderWidth:1,titleColor:'#c9a84c',bodyColor:'#9a9890',titleFont:{family:"'IBM Plex Mono',monospace",size:11},bodyFont:{family:"'IBM Plex Mono',monospace",size:10},padding:10,callbacks:{}}},
    scales:{x:{grid:{color:'rgba(42,42,47,0.5)',drawBorder:false},ticks:{color:'#6b6a64',font:{family:"'IBM Plex Mono',monospace",size:9},maxRotation:0}},y:{grid:{color:'rgba(42,42,47,0.5)',drawBorder:false},ticks:{color:'#6b6a64',font:{family:"'IBM Plex Mono',monospace",size:9}}}}};
}
function buildAnalytics(){
  const allDays=Object.keys(state.days).sort();
  if(!allDays.length){
    ['noDataYearly','noDataMonthly','noDataWeekly','noDataChecklist'].forEach(id=>document.getElementById(id).style.display='block');
    ['yearlyChart','monthlyChart','weeklyChart','checklistChart'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none';});
    updateKPIs(allDays);return;
  }
  updateKPIs(allDays);buildYearlyChart(allDays);buildMonthlyChart(allDays);buildWeeklyChart(allDays);buildBehaviourGrid(allDays);buildChecklistChart(allDays);
}
function updateKPIs(allDays){
  const allTrades=allDays.flatMap(d=>(state.days[d].trades||[]));
  const allWins=allTrades.filter(t=>t.pnl>0);
  const totalPnl=allTrades.reduce((s,t)=>s+t.pnl,0);
  const wr=allTrades.length?Math.round((allWins.length/allTrades.length)*100):null;
  const dayPnls=allDays.map(d=>({date:d,pnl:dayPnl(state.days[d])}));
  const profitDays=dayPnls.filter(d=>d.pnl>0);
  const bestDay=dayPnls.reduce((a,b)=>b.pnl>a.pnl?b:a,{pnl:-Infinity,date:'‚Äî'});
  const worstDay=dayPnls.reduce((a,b)=>b.pnl<a.pnl?b:a,{pnl:Infinity,date:'‚Äî'});
  const el=document.getElementById;
  el('kTotal').textContent=`‚Çπ${totalPnl.toLocaleString('en-IN',{minimumFractionDigits:0})}`;
  el('kTotal').className=`kpi-value ${totalPnl>0?'green':totalPnl<0?'red':''}`;
  el('kTotalSub').textContent=`${allDays.length} trading day${allDays.length!==1?'s':''}`;
  el('kWin').textContent=wr!==null?`${wr}%`:'‚Äî';
  el('kWin').className=`kpi-value ${wr>=50?'green':'red'}`;
  el('kWinSub').textContent=`${allWins.length} / ${allTrades.length} trades`;
  el('kBestDay').textContent=bestDay.pnl>-Infinity?`+‚Çπ${bestDay.pnl.toLocaleString('en-IN')}`:'‚Äî';
  el('kBestDayDate').textContent=bestDay.date!=='‚Äî'?bestDay.date:'‚Äî';
  el('kWorstDay').textContent=worstDay.pnl<Infinity?`‚Çπ${worstDay.pnl.toLocaleString('en-IN')}`:'‚Äî';
  el('kWorstDayDate').textContent=worstDay.date!=='‚Äî'?worstDay.date:'‚Äî';
  el('kAvgDay').textContent=allDays.length?`‚Çπ${(totalPnl/allDays.length).toFixed(0)}`:'‚Äî';
  el('kAvgDay').className=`kpi-value ${(totalPnl/allDays.length)>0?'green':'red'}`;
  el('kProfitDays').textContent=allDays.length?`${profitDays.length}/${allDays.length}`:'‚Äî';
}
function buildYearlyChart(allDays){
  destroyChart('yearly');
  document.getElementById('noDataYearly').style.display='none';
  const canvas=document.getElementById('yearlyChart'); canvas.style.display='block';
  const traderByDate={}; let cum=0;
  allDays.forEach(d=>{cum+=dayPnl(state.days[d]);traderByDate[d]=(cum/STARTING_CAPITAL)*100;});
  const startDate=allDays[0];
  const n50f=(state.nifty50||[]).filter(d=>d.date>=startDate);
  const n500f=(state.nifty500||[]).filter(d=>d.date>=startDate);
  function normPct(arr){if(!arr.length)return[];const base=arr[0].close;return arr.map(d=>({date:d.date,pct:((d.close-base)/base)*100}));}
  const n50pct=normPct(n50f),n500pct=normPct(n500f);
  const allDates=[...new Set([...allDays,...n50pct.map(d=>d.date),...n500pct.map(d=>d.date)])].sort().slice(-365);
  const n50map=Object.fromEntries(n50pct.map(d=>[d.date,d.pct]));
  const n500map=Object.fromEntries(n500pct.map(d=>[d.date,d.pct]));
  let lt=0,ln50=null,ln500=null;
  const traderSeries=allDates.map(d=>{if(traderByDate[d]!==undefined)lt=traderByDate[d];return lt;});
  const n50series=allDates.map(d=>{if(n50map[d]!==undefined)ln50=n50map[d];return ln50;});
  const n500series=allDates.map(d=>{if(n500map[d]!==undefined)ln500=n500map[d];return ln500;});
  const step=Math.max(1,Math.floor(allDates.length/12));
  const labels=allDates.map((d,i)=>i%step===0?d.slice(5):'');
  const cfg=getChartDefaults();
  cfg.plugins.tooltip.callbacks.label=ctx=>`${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%`;
  cfg.scales.y.ticks.callback=v=>v.toFixed(1)+'%';
  cfg.plugins.legend={display:true,labels:{color:'#9a9890',font:{family:"'IBM Plex Mono',monospace",size:10},boxWidth:24,boxHeight:3,padding:16}};
  charts['yearly']=new Chart(canvas.getContext('2d'),{type:'line',data:{labels,datasets:[
    {label:'Your P&L %',data:traderSeries,borderColor:'var(--trader-color)',backgroundColor:'rgba(201,168,76,0.06)',borderWidth:2.5,pointRadius:0,tension:0.3,fill:true},
    {label:'Nifty 50',data:n50series,borderColor:'var(--nifty50-color)',backgroundColor:'transparent',borderWidth:1.5,pointRadius:0,tension:0.3,borderDash:[4,3]},
    {label:'Nifty 500',data:n500series,borderColor:'var(--nifty500-color)',backgroundColor:'transparent',borderWidth:1.5,pointRadius:0,tension:0.3,borderDash:[2,4]}
  ]},options:{...cfg,interaction:{mode:'index',intersect:false}}});
}
function buildMonthlyChart(allDays){
  destroyChart('monthly');
  document.getElementById('noDataMonthly').style.display='none';
  const canvas=document.getElementById('monthlyChart');canvas.style.display='block';
  const monthly={};
  allDays.forEach(d=>{const m=d.slice(0,7);if(!monthly[m])monthly[m]=0;monthly[m]+=dayPnl(state.days[d]);});
  const labels=Object.keys(monthly).sort();
  const data=labels.map(m=>parseFloat(monthly[m].toFixed(2)));
  const cfg=getChartDefaults();
  cfg.plugins.tooltip.callbacks.label=ctx=>`‚Çπ${ctx.parsed.y.toLocaleString('en-IN')}`;
  cfg.scales.y.ticks.callback=v=>`‚Çπ${v>=0?'+':''}${v.toLocaleString('en-IN')}`;
  charts['monthly']=new Chart(canvas.getContext('2d'),{type:'bar',data:{labels,datasets:[{data,backgroundColor:data.map(v=>v>=0?'rgba(76,175,136,0.7)':'rgba(224,82,82,0.7)'),borderColor:data.map(v=>v>=0?'var(--green)':'var(--red)'),borderWidth:1,borderRadius:3}]},options:cfg});
}
function buildWeeklyChart(allDays){
  destroyChart('weekly');
  document.getElementById('noDataWeekly').style.display='none';
  const canvas=document.getElementById('weeklyChart');canvas.style.display='block';
  function getWeekKey(ds){const d=new Date(ds);const day=d.getDay(),diff=d.getDate()-day+(day===0?-6:1);return new Date(d.setDate(diff)).toISOString().slice(0,10);}
  const weekly={};
  allDays.forEach(d=>{const wk=getWeekKey(d);if(!weekly[wk])weekly[wk]=0;weekly[wk]+=dayPnl(state.days[d]);});
  const sorted=Object.keys(weekly).sort().slice(-12);
  const data=sorted.map(w=>parseFloat(weekly[w].toFixed(2)));
  const cfg=getChartDefaults();
  cfg.plugins.tooltip.callbacks.label=ctx=>`‚Çπ${ctx.parsed.y.toLocaleString('en-IN')}`;
  cfg.scales.y.ticks.callback=v=>`‚Çπ${(v/1000).toFixed(1)}k`;
  charts['weekly']=new Chart(canvas.getContext('2d'),{type:'bar',data:{labels:sorted.map(d=>'w/'+d.slice(5)),datasets:[{data,backgroundColor:data.map(v=>v>=0?'rgba(76,175,136,0.7)':'rgba(224,82,82,0.7)'),borderColor:data.map(v=>v>=0?'var(--green)':'var(--red)'),borderWidth:1,borderRadius:3}]},options:cfg});
}
function buildBehaviourGrid(allDays){
  const allTrades=allDays.flatMap(d=>(state.days[d].trades||[]));
  const flagTypes=[{key:'Delayed',label:'Delayed SL',color:'var(--orange)'},{key:'Revenge',label:'Revenge Trade',color:'var(--red)'},{key:'Risky',label:'Risky Setup',color:'var(--blue)'},{key:'FOMO',label:'FOMO Entry',color:'var(--purple)'},{key:'‚úÖ',label:'Disciplined',color:'var(--green)'}];
  if(!allTrades.length){document.getElementById('behaviourGrid').innerHTML=`<div style="text-align:center;padding:24px;color:var(--text-muted);font-family:'IBM Plex Mono',monospace;font-size:11px;grid-column:1/-1;">Log trades with behaviour tags to see analysis here.</div>`;return;}
  document.getElementById('behaviourGrid').innerHTML=flagTypes.map(ft=>{
    const tagged=allTrades.filter(t=>t.flags.some(f=>f.includes(ft.key)));
    const avg=tagged.length?tagged.reduce((s,t)=>s+t.pnl,0)/tagged.length:0;
    const wins=tagged.filter(t=>t.pnl>0).length;
    const wr=tagged.length?Math.round((wins/tagged.length)*100):0;
    return `<div class="beh-card"><div class="beh-count" style="color:${ft.color}">${tagged.length}</div><div class="beh-label">${ft.label}</div><div class="beh-impact" style="color:${avg>=0?'var(--green)':'var(--red)'}">avg ‚Çπ${avg.toFixed(0)}</div><div style="font-size:9px;font-family:'IBM Plex Mono',monospace;color:var(--text-muted);margin-top:2px;">${wr}% win rate</div></div>`;
  }).join('');
}
function buildChecklistChart(allDays){
  destroyChart('checklist');
  document.getElementById('noDataChecklist').style.display='none';
  const canvas=document.getElementById('checklistChart');canvas.style.display='block';
  const allTrades=allDays.flatMap(d=>(state.days[d].trades||[]));
  if(!allTrades.length){document.getElementById('noDataChecklist').style.display='block';canvas.style.display='none';return;}
  const labels=['5/10 Min Chart','Buy/Sell Area','FVG Retest'];
  const data=labels.map((_,i)=>{const checked=allTrades.filter(t=>t.checks[i]).length;return Math.round((checked/allTrades.length)*100);});
  const cfg=getChartDefaults();
  cfg.plugins.tooltip.callbacks.label=ctx=>`${ctx.parsed.x}% compliance`;
  cfg.scales.x={...cfg.scales.x,min:0,max:100,ticks:{...cfg.scales.x.ticks,callback:v=>v+'%'}};
  cfg.scales.y={...cfg.scales.y,grid:{display:false},ticks:{color:'#9a9890',font:{family:"'IBM Plex Mono',monospace",size:10}}};
  delete cfg.scales.y.ticks.callback;
  charts['checklist']=new Chart(canvas.getContext('2d'),{type:'bar',data:{labels,datasets:[{data,backgroundColor:data.map(v=>v>=80?'rgba(76,175,136,0.6)':v>=50?'rgba(245,166,35,0.6)':'rgba(224,82,82,0.6)'),borderColor:data.map(v=>v>=80?'var(--green)':v>=50?'var(--orange)':'var(--red)'),borderWidth:1,borderRadius:3}]},options:{...cfg,indexAxis:'y'}});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATE/TIME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateDateTime(){
  const now=new Date();
  document.getElementById('currentDate').textContent=now.toLocaleDateString('en-IN',{weekday:'short',day:'2-digit',month:'short',year:'numeric'});
  document.getElementById('currentTime').textContent=now.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  APP START (after login)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startApp() {
  updateDateTime();
  setInterval(updateDateTime,1000);
  showQuote(0);
  setInterval(nextQuote,90000);

  const picker=document.getElementById('datePicker');
  picker.value=today(); picker.max=today();

  // Load all data from Sheets
  await loadAllData();

  setActiveDate(today());
  if(activeDayData().completed){
    document.getElementById('dayCompleteBtn').classList.add('done');
    document.getElementById('dayCompleteBtn').textContent='‚úì Day Complete';
  }
  fetchNiftyData();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('load', () => {
  updateDateTime();
  setInterval(updateDateTime,1000);
  // Init Google Sign-In once the GSI library is loaded
  const waitForGSI = setInterval(() => {
    if (window.google && google.accounts) {
      clearInterval(waitForGSI);
      initGoogleSignIn();
    }
  }, 100);
});
</script>
</body>
</html>
