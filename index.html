<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TradeEdge ‚Äî Daily Journal</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@300;400;500&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
:root {
  --bg: #f8f9fc;
  --surface: #ffffff;
  --surface2: #f1f4f9;
  --border: #e2e8f0;
  --border-light: #f1f5f9;
  --accent: #6366f1;
  --accent-hover: #4f46e5;
  --accent-light: #eef0ff;
  --accent-dim: #a5b4fc;
  --green: #10b981;
  --green-light: #ecfdf5;
  --red: #ef4444;
  --red-light: #fef2f2;
  --amber: #f59e0b;
  --amber-light: #fffbeb;
  --blue: #3b82f6;
  --blue-light: #eff6ff;
  --purple: #8b5cf6;
  --text: #0f172a;
  --text-2: #334155;
  --text-muted: #64748b;
  --text-dim: #94a3b8;
  --shadow-sm: 0 1px 3px rgba(15,23,42,0.06), 0 1px 2px rgba(15,23,42,0.04);
  --shadow: 0 4px 6px -1px rgba(15,23,42,0.07), 0 2px 4px -1px rgba(15,23,42,0.04);
  --shadow-md: 0 10px 15px -3px rgba(15,23,42,0.08), 0 4px 6px -2px rgba(15,23,42,0.04);
  --shadow-lg: 0 20px 40px rgba(15,23,42,0.10);
  --radius: 12px; --radius-sm: 8px; --radius-lg: 18px;
  --nifty50-color: #3b82f6; --nifty500-color: #8b5cf6; --trader-color: #6366f1;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; overflow-x: hidden; font-size: 14px; line-height: 1.5; }

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header { display: flex; align-items: center; justify-content: space-between; padding: 0 32px; height: 62px; border-bottom: 1px solid var(--border); background: var(--surface); position: sticky; top: 0; z-index: 200; box-shadow: var(--shadow-sm); }
.logo { display: flex; align-items: center; gap: 10px; }
.logo-mark { width: 34px; height: 34px; border-radius: 9px; background: linear-gradient(135deg, #6366f1, #8b5cf6); display: flex; align-items: center; justify-content: center; font-family: 'Instrument Serif', serif; font-size: 18px; color: white; box-shadow: 0 3px 10px rgba(99,102,241,0.35); }
.logo-text { font-size: 17px; font-weight: 700; color: var(--text); letter-spacing: -0.3px; }
.logo-text span { color: var(--accent); }
.header-right { display: flex; align-items: center; gap: 12px; }
.header-meta { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--text-muted); text-align: right; line-height: 1.5; }
.pnl-badge { padding: 5px 14px; border-radius: 20px; font-family: 'DM Mono', monospace; font-size: 14px; font-weight: 500; transition: all 0.3s; }
.pnl-badge.profit { color: var(--green); background: var(--green-light); }
.pnl-badge.loss { color: var(--red); background: var(--red-light); }
.pnl-badge.neutral { color: var(--text-muted); background: var(--surface2); }

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
.nav-tabs { display: flex; padding: 0 32px; background: var(--surface); border-bottom: 1px solid var(--border); position: sticky; top: 62px; z-index: 190; }
.nav-tab { padding: 14px 20px; font-size: 13px; font-weight: 500; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; user-select: none; display: flex; align-items: center; gap: 7px; }
.nav-tab:hover { color: var(--text-2); }
.nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: 600; }

/* ‚îÄ‚îÄ STATUS BAR ‚îÄ‚îÄ */
.status-bar { background: var(--surface); border-bottom: 1px solid var(--border); padding: 10px 32px; display: flex; align-items: center; flex-wrap: wrap; }
.status-item { display: flex; flex-direction: column; gap: 1px; padding: 6px 22px; border-right: 1px solid var(--border); }
.status-item:first-child { padding-left: 0; }
.status-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-dim); font-weight: 600; }
.status-value { font-size: 17px; font-family: 'DM Mono', monospace; font-weight: 500; color: var(--text); }
.status-value.green { color: var(--green); }
.status-value.red { color: var(--red); }
.status-value.gold { color: var(--accent); }

/* ‚îÄ‚îÄ DAILY TARGET (editable) ‚îÄ‚îÄ */
.target-item { display: flex; flex-direction: column; gap: 1px; padding: 6px 22px; border-right: 1px solid var(--border); }
.target-row { display: flex; align-items: center; gap: 6px; }
.target-input { font-size: 16px; font-family: 'DM Mono', monospace; font-weight: 500; color: var(--accent); background: transparent; border: none; outline: none; width: 90px; cursor: text; }
.target-input:focus { background: var(--accent-light); border-radius: 4px; padding: 2px 4px; }

.progress-section { flex: 1; min-width: 180px; padding: 6px 22px; }
.progress-label { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); font-weight: 500; margin-bottom: 6px; }
.progress-bar { height: 4px; background: var(--border); border-radius: 4px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, var(--accent), var(--purple)); transition: width 0.6s ease; }
.day-complete-btn { margin-left: auto; padding: 8px 18px; background: var(--accent-light); border: 1.5px solid var(--accent-dim); color: var(--accent); border-radius: var(--radius-sm); font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; font-family: 'DM Sans', sans-serif; }
.day-complete-btn:hover { background: var(--accent); color: white; border-color: var(--accent); }
.day-complete-btn.done { background: var(--green-light); border-color: var(--green); color: var(--green); }

/* ‚îÄ‚îÄ NSE BANNER ‚îÄ‚îÄ */
.nse-bar { background: var(--surface); border-bottom: 1px solid var(--border); padding: 8px 32px; display: flex; align-items: center; gap: 16px; overflow: hidden; min-height: 38px; }
.nse-bar-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); white-space: nowrap; }
.nse-holiday-badge { display: flex; align-items: center; gap: 6px; padding: 4px 12px; background: var(--amber-light); border: 1px solid #fcd34d; border-radius: 20px; font-size: 12px; font-weight: 600; color: #92400e; white-space: nowrap; }
.nse-news-scroll { display: flex; gap: 24px; overflow: hidden; flex: 1; }
.nse-news-item { display: flex; align-items: center; gap: 8px; white-space: nowrap; font-size: 12px; color: var(--text-muted); flex-shrink: 0; }
.nse-news-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent-dim); flex-shrink: 0; }
.nse-news-ticker { font-family: 'DM Mono', monospace; font-size: 11px; font-weight: 600; color: var(--accent); }
.nse-news-marquee { overflow: hidden; flex: 1; mask-image: linear-gradient(90deg, transparent, black 5%, black 95%, transparent); }
.nse-news-track { display: flex; gap: 40px; animation: marquee 40s linear infinite; }
@keyframes marquee { from{transform:translateX(0)} to{transform:translateX(-50%)} }

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.page { display: none; }
.page.active { display: block; }

/* ‚îÄ‚îÄ JOURNAL LAYOUT ‚îÄ‚îÄ */
.journal-layout { display: grid; grid-template-columns: 1fr 340px; min-height: calc(100vh - 210px); }
.left-panel { padding: 28px 32px; border-right: 1px solid var(--border); }
.right-panel { background: var(--surface); display: flex; flex-direction: column; }

/* ‚îÄ‚îÄ SECTION TITLES ‚îÄ‚îÄ */
.section-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 14px; margin-top: 28px; display: flex; align-items: center; gap: 10px; }
.section-title:first-child { margin-top: 0; }
.section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

/* ‚îÄ‚îÄ FORCE STOP ‚îÄ‚îÄ */
.force-stop-banner { display: none; background: var(--red-light); border: 1.5px solid #fca5a5; border-radius: var(--radius-sm); padding: 12px 18px; margin-bottom: 20px; font-size: 13px; font-weight: 600; color: var(--red); text-align: center; animation: pulseBorder 2s infinite; }
.force-stop-banner.show { display: block; }
@keyframes pulseBorder { 0%,100%{opacity:1}50%{opacity:0.65} }

/* ‚îÄ‚îÄ TRADE FORM ‚îÄ‚îÄ */
.trade-form { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow-sm); margin-bottom: 28px; }
.form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; }
.form-grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px; }
.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-group label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.6px; }
.form-group input, .form-group select, .form-group textarea { padding: 9px 12px; border: 1.5px solid var(--border); border-radius: var(--radius-sm); font-size: 13px; background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; transition: all 0.2s; outline: none; }
.form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--accent); background: var(--surface); box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
.pnl-auto { font-size: 11px; color: var(--text-dim); margin-top: 3px; font-family: 'DM Mono', monospace; }
.pnl-auto.pos { color: var(--green); }
.pnl-auto.neg { color: var(--red); }

/* ‚îÄ‚îÄ CHECKLIST (proper checkboxes) ‚îÄ‚îÄ */
.checklist-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; }
.check-row { display: flex; align-items: flex-start; gap: 10px; padding: 10px 12px; border: 1.5px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s; background: var(--bg); }
.check-row:hover { border-color: var(--accent-dim); background: var(--accent-light); }
.check-row.checked { border-color: var(--accent); background: var(--accent-light); }
.check-box { width: 18px; height: 18px; min-width: 18px; border-radius: 4px; border: 2px solid var(--border); background: white; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 11px; color: transparent; margin-top: 1px; }
.check-row.checked .check-box { background: var(--accent); border-color: var(--accent); color: white; }
.check-row:hover .check-box { border-color: var(--accent-dim); }
.check-content { flex: 1; }
.check-title { font-size: 12px; font-weight: 600; color: var(--text); margin-bottom: 2px; }
.check-desc { font-size: 11px; color: var(--text-muted); line-height: 1.4; }
.check-row.checked .check-title { color: var(--accent); }

/* ‚îÄ‚îÄ FLAGS ‚îÄ‚îÄ */
.flag-row { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 16px; }
.flag-chip { padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; user-select: none; border: 1.5px solid var(--border); background: var(--bg); color: var(--text-muted); }
.flag-chip.delayed-sl.active { background: #fff7ed; border-color: #fdba74; color: #c2410c; }
.flag-chip.revenge.active { background: var(--red-light); border-color: #fca5a5; color: var(--red); }
.flag-chip.risky.active { background: var(--blue-light); border-color: #93c5fd; color: var(--blue); }
.flag-chip.fomo.active { background: #faf5ff; border-color: #c4b5fd; color: #7c3aed; }
.flag-chip.disciplined.active { background: var(--green-light); border-color: #6ee7b7; color: #059669; }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 4px; }
.btn-primary { padding: 9px 22px; background: var(--accent); color: white; border: none; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
.btn-primary:hover { background: var(--accent-hover); box-shadow: 0 4px 14px rgba(99,102,241,0.35); transform: translateY(-1px); }
.btn-secondary { padding: 9px 18px; background: transparent; color: var(--text-muted); border: 1.5px solid var(--border); border-radius: var(--radius-sm); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
.btn-secondary:hover { border-color: var(--text-dim); color: var(--text-2); }

/* ‚îÄ‚îÄ TRADE LOG ‚îÄ‚îÄ */
.log-header { display: grid; grid-template-columns: 90px 55px 80px 80px 90px 50px 1fr 1fr; gap: 8px; padding: 8px 14px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.7px; color: var(--text-dim); border-bottom: 1px solid var(--border); background: var(--surface2); border-radius: var(--radius-sm); margin-bottom: 2px; }
.trade-row { display: grid; grid-template-columns: 90px 55px 80px 80px 90px 50px 1fr 1fr; gap: 8px; padding: 11px 14px; border-bottom: 1px solid var(--border-light); transition: background 0.15s; align-items: center; font-size: 13px; animation: fadeUp 0.3s ease; }
.trade-row:hover { background: var(--surface2); }
@keyframes fadeUp { from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)} }
.trade-symbol { font-weight: 700; color: var(--text); }
.trade-dir { font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 12px; text-align: center; }
.trade-dir.long { background: var(--green-light); color: var(--green); }
.trade-dir.short { background: var(--red-light); color: var(--red); }
.trade-col { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--text-2); }
.trade-pnl { font-family: 'DM Mono', monospace; font-weight: 600; font-size: 13px; }
.trade-pnl.pos { color: var(--green); }
.trade-pnl.neg { color: var(--red); }
.mini-flag { font-size: 10px; font-weight: 600; padding: 2px 7px; border-radius: 8px; display: inline-block; margin-right: 2px; }
.mf-delayed { background: #fff7ed; color: #c2410c; }
.mf-revenge { background: var(--red-light); color: var(--red); }
.mf-risky { background: var(--blue-light); color: var(--blue); }
.mf-fomo { background: #faf5ff; color: #7c3aed; }
.mf-disciplined { background: var(--green-light); color: #059669; }
.ci { font-size: 12px; opacity: 0.25; }
.ci.ok { opacity: 1; }
.delete-trade { opacity: 0; background: transparent; border: none; color: var(--text-dim); cursor: pointer; font-size: 12px; padding: 3px 6px; border-radius: 4px; transition: all 0.15s; }
.trade-row:hover .delete-trade { opacity: 1; }
.delete-trade:hover { color: var(--red); background: var(--red-light); }
.empty-state { text-align: center; padding: 48px; color: var(--text-dim); font-size: 13px; border: 2px dashed var(--border); border-radius: var(--radius); margin-top: 8px; }
.empty-state .icon { font-size: 32px; margin-bottom: 12px; display: block; opacity: 0.35; }

/* ‚îÄ‚îÄ RIGHT PANEL ‚îÄ‚îÄ */
.mindful-section { padding: 20px; border-bottom: 1px solid var(--border); }
.right-section-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 14px; }
.quote-card { background: linear-gradient(135deg, var(--accent-light), #f5f3ff); border: 1px solid var(--accent-dim); border-radius: var(--radius); padding: 18px; position: relative; overflow: hidden; margin-bottom: 14px; }
.quote-card::before { content: '"'; position: absolute; top: -10px; left: 12px; font-family: 'Instrument Serif', serif; font-size: 80px; color: var(--accent-dim); opacity: 0.2; line-height: 1; }
.quote-text { font-family: 'Instrument Serif', serif; font-size: 13px; line-height: 1.75; color: var(--text); font-style: italic; margin-bottom: 8px; position: relative; z-index: 1; }
.quote-author { font-size: 10px; color: var(--accent); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
.quote-nav { display: flex; gap: 6px; margin-top: 10px; }
.quote-btn { padding: 4px 10px; background: white; border: 1px solid var(--border); color: var(--text-muted); border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
.quote-btn:hover { border-color: var(--accent); color: var(--accent); }
.breathing-widget { text-align: center; padding: 12px 0 4px; }
.breath-ring { width: 88px; height: 88px; border-radius: 50%; border: 2px solid var(--border); margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; position: relative; }
.breath-ring-fill { position: absolute; inset: 8px; border-radius: 50%; background: radial-gradient(circle, rgba(99,102,241,0.2), rgba(99,102,241,0.05)); transform: scale(0.3); transition: transform 0s; }
.breath-ring-fill.inhale { transform: scale(1); transition: transform 4s ease-in-out; }
.breath-ring-fill.hold { transform: scale(1); }
.breath-ring-fill.exhale { transform: scale(0.3); transition: transform 6s ease-in-out; }
.breath-label { font-size: 11px; color: var(--accent); letter-spacing: 1.5px; text-transform: uppercase; font-weight: 700; }
.breath-instruction { font-size: 11px; color: var(--text-muted); margin-top: 3px; }
.breath-btn { margin-top: 10px; padding: 6px 20px; background: var(--accent-light); border: 1.5px solid var(--accent-dim); color: var(--accent); border-radius: 20px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
.breath-btn:hover { background: var(--accent); color: white; }

/* ‚îÄ‚îÄ SUGGESTIONS ‚îÄ‚îÄ */
.suggestions-section { padding: 20px; border-bottom: 1px solid var(--border); }
.suggestion-card { padding: 11px 13px; border-radius: var(--radius-sm); margin-bottom: 8px; border-left: 3px solid; font-size: 12px; line-height: 1.65; color: var(--text-2); animation: fadeUp 0.3s ease; }
.suggestion-card.warning { border-color: var(--amber); background: var(--amber-light); }
.suggestion-card.danger { border-color: var(--red); background: var(--red-light); }
.suggestion-card.positive { border-color: var(--green); background: var(--green-light); }
.suggestion-card.info { border-color: var(--accent); background: var(--accent-light); }
.suggestion-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 4px; }
.suggestion-card.warning .suggestion-label { color: #b45309; }
.suggestion-card.danger .suggestion-label { color: var(--red); }
.suggestion-card.positive .suggestion-label { color: #059669; }
.suggestion-card.info .suggestion-label { color: var(--accent); }

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.stats-section { padding: 20px; }
.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.stat-box { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 12px; }
.stat-box-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.7px; color: var(--text-dim); font-weight: 600; margin-bottom: 3px; }
.stat-box-value { font-size: 16px; font-family: 'DM Mono', monospace; font-weight: 500; color: var(--text); }
.stat-box-value.green { color: var(--green); }
.stat-box-value.red { color: var(--red); }
.stat-box-value.gold { color: var(--accent); }

/* ‚îÄ‚îÄ P&L CALENDAR ‚îÄ‚îÄ */
.calendar-page { padding: 32px; }
.cal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
.cal-title { font-family: 'Instrument Serif', serif; font-size: 30px; color: var(--text); }
.cal-title span { color: var(--accent); font-style: italic; }
.cal-period-tabs { display: flex; gap: 0; border: 1px solid var(--border); border-radius: var(--radius-sm); overflow: hidden; }
.cal-period-tab { padding: 8px 18px; font-size: 12px; font-weight: 600; cursor: pointer; background: var(--bg); color: var(--text-muted); border: none; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
.cal-period-tab.active { background: var(--accent); color: white; }
.cal-period-tab:hover:not(.active) { background: var(--surface2); color: var(--text-2); }
.cal-summary-strip { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin-bottom: 28px; }
.cal-sum-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; box-shadow: var(--shadow-sm); }
.cal-sum-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-dim); font-weight: 700; margin-bottom: 6px; }
.cal-sum-value { font-size: 24px; font-family: 'DM Mono', monospace; font-weight: 500; }
.cal-sum-sub { font-size: 11px; color: var(--text-dim); margin-top: 3px; }
.cal-nav { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
.cal-nav-btn { width: 32px; height: 32px; border: 1.5px solid var(--border); background: var(--surface); border-radius: var(--radius-sm); cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: var(--text-muted); }
.cal-nav-btn:hover { border-color: var(--accent); color: var(--accent); }
.cal-nav-label { font-size: 16px; font-weight: 600; color: var(--text); min-width: 140px; text-align: center; }
.cal-grid { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow-sm); }
.cal-weekdays { display: grid; grid-template-columns: repeat(7,1fr); background: var(--surface2); }
.cal-weekday { padding: 10px; text-align: center; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-dim); }
.cal-weekday:nth-child(6), .cal-weekday:nth-child(7) { color: var(--text-dim); opacity: 0.6; }
.cal-days { display: grid; grid-template-columns: repeat(7,1fr); }
.cal-day { min-height: 90px; padding: 10px; border-right: 1px solid var(--border-light); border-bottom: 1px solid var(--border-light); position: relative; cursor: default; transition: background 0.15s; }
.cal-day:nth-child(7n) { border-right: none; }
.cal-day.empty { background: var(--bg); }
.cal-day.weekend { background: #fafafa; }
.cal-day.holiday { background: #fffbf0; }
.cal-day.today { background: var(--accent-light); }
.cal-day.has-data { cursor: pointer; }
.cal-day.has-data:hover { background: var(--surface2); }
.cal-day-num { font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between; }
.cal-day.today .cal-day-num { color: var(--accent); }
.cal-day-today-dot { width: 20px; height: 20px; border-radius: 50%; background: var(--accent); color: white; font-size: 11px; font-weight: 700; display: flex; align-items: center; justify-content: center; }
.cal-day-pnl { font-family: 'DM Mono', monospace; font-size: 13px; font-weight: 600; }
.cal-day-pnl.pos { color: var(--green); }
.cal-day-pnl.neg { color: var(--red); }
.cal-day-trades { font-size: 10px; color: var(--text-dim); margin-top: 3px; }
.cal-day-bar { position: absolute; bottom: 0; left: 0; right: 0; height: 3px; border-radius: 0 0 0 0; }
.cal-day-bar.pos { background: var(--green); }
.cal-day-bar.neg { background: var(--red); }
.cal-day-holiday-label { font-size: 9px; font-weight: 600; color: var(--amber); text-transform: uppercase; letter-spacing: 0.5px; }
.cal-day-complete-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); display: inline-block; }

/* ‚îÄ‚îÄ ANALYTICS ‚îÄ‚îÄ */
.analytics-page { padding: 32px; }
.analytics-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 28px; flex-wrap: wrap; gap: 16px; }
.analytics-title { font-family: 'Instrument Serif', serif; font-size: 32px; color: var(--text); font-weight: 400; }
.analytics-title span { color: var(--accent); font-style: italic; }
.analytics-subtitle { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
.nifty-status { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
.nifty-badge { display: flex; flex-direction: column; gap: 2px; padding: 10px 16px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--surface); box-shadow: var(--shadow-sm); }
.nifty-badge-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
.nifty-badge-value { font-size: 15px; font-family: 'DM Mono', monospace; font-weight: 500; }
.nifty-status-text { font-size: 11px; color: var(--text-muted); }
.kpi-strip { display: grid; grid-template-columns: repeat(6,1fr); gap: 12px; margin-bottom: 24px; }
.kpi-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; box-shadow: var(--shadow-sm); transition: all 0.2s; }
.kpi-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
.kpi-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-dim); font-weight: 700; margin-bottom: 6px; }
.kpi-value { font-size: 22px; font-family: 'DM Mono', monospace; font-weight: 500; }
.kpi-value.green { color: var(--green); }
.kpi-value.red { color: var(--red); }
.kpi-value.gold { color: var(--accent); }
.kpi-sub { font-size: 11px; color: var(--text-dim); margin-top: 3px; }
.charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
.chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 22px; box-shadow: var(--shadow-sm); }
.chart-card.full { grid-column: 1/-1; }
.chart-title { font-size: 15px; font-weight: 600; color: var(--text); margin-bottom: 3px; }
.chart-subtitle { font-size: 11px; color: var(--text-muted); margin-bottom: 16px; }
.chart-legend { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 12px; }
.legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-muted); font-weight: 500; }
.legend-dot { width: 12px; height: 3px; border-radius: 2px; }
canvas { max-height: 280px; }
.behaviour-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 10px; }
.beh-card { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 16px; text-align: center; transition: all 0.2s; }
.beh-card:hover { box-shadow: var(--shadow); transform: translateY(-1px); }
.beh-count { font-size: 30px; font-family: 'DM Mono', monospace; font-weight: 600; }
.beh-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.7px; color: var(--text-muted); margin-top: 4px; }
.beh-impact { font-size: 12px; font-family: 'DM Mono', monospace; margin-top: 6px; font-weight: 500; }
.no-data-msg { text-align: center; padding: 60px; color: var(--text-dim); font-size: 13px; }
.no-data-msg .big { font-size: 36px; margin-bottom: 12px; opacity: 0.25; display: block; }

/* ‚îÄ‚îÄ OVERLAY ‚îÄ‚îÄ */
.overlay { display: none; position: fixed; inset: 0; background: rgba(248,249,252,0.96); backdrop-filter: blur(20px); z-index: 500; align-items: center; justify-content: center; flex-direction: column; gap: 14px; text-align: center; }
.overlay.show { display: flex; animation: fadeUp 0.4s ease; }
.overlay-eyebrow { font-size: 11px; font-weight: 700; letter-spacing: 2.5px; color: var(--text-dim); text-transform: uppercase; }
.overlay-title { font-family: 'Instrument Serif', serif; font-size: 56px; color: var(--accent); }
.overlay-pnl { font-family: 'DM Mono', monospace; font-size: 38px; font-weight: 500; }
.overlay-msg { font-size: 14px; color: var(--text-muted); max-width: 440px; line-height: 1.8; }
.overlay-close { margin-top: 20px; padding: 12px 32px; border: 1.5px solid var(--accent); color: var(--accent); background: transparent; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
.overlay-close:hover { background: var(--accent); color: white; }

/* ‚îÄ‚îÄ DATE BAR ‚îÄ‚îÄ */
.active-date-bar { display: flex; align-items: center; gap: 12px; padding: 10px 32px; background: var(--surface2); border-bottom: 1px solid var(--border); flex-wrap: wrap; }
.active-date-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-dim); }
.date-picker-input { background: var(--surface); border: 1.5px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: var(--radius-sm); font-family: 'DM Mono', monospace; font-size: 12px; outline: none; cursor: pointer; transition: all 0.2s; }
.date-picker-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
.date-jump-btn { padding: 6px 14px; background: var(--surface); border: 1.5px solid var(--border); color: var(--text-muted); border-radius: var(--radius-sm); font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
.date-jump-btn:hover { border-color: var(--accent); color: var(--accent); }
.date-jump-btn.today-btn { border-color: var(--accent-dim); color: var(--accent); background: var(--accent-light); }
.viewing-past-badge { padding: 4px 12px; border-radius: 20px; background: var(--blue-light); border: 1px solid #93c5fd; color: var(--blue); font-size: 11px; font-weight: 600; }
.date-pnl-pill { padding: 4px 12px; border-radius: 20px; font-family: 'DM Mono', monospace; font-size: 12px; font-weight: 500; border: 1.5px solid; }
.past-days-toggle { margin-left: auto; padding: 6px 14px; background: var(--surface); border: 1.5px solid var(--border); color: var(--text-muted); border-radius: var(--radius-sm); font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; white-space: nowrap; font-family: 'DM Sans', sans-serif; }
.past-days-toggle:hover { border-color: var(--accent); color: var(--accent); }
.past-days-panel { display: none; background: var(--surface); border-bottom: 1px solid var(--border); padding: 14px 32px; }
.past-days-panel.open { display: block; animation: fadeUp 0.2s ease; }
.past-days-scroll { display: flex; gap: 8px; flex-wrap: wrap; }
.day-pill { display: flex; flex-direction: column; gap: 2px; padding: 10px 16px; border-radius: var(--radius-sm); border: 1.5px solid var(--border); cursor: pointer; transition: all 0.18s; background: var(--bg); min-width: 100px; text-align: center; }
.day-pill:hover { border-color: var(--accent-dim); background: var(--accent-light); }
.day-pill.active-day { border-color: var(--accent); background: var(--accent-light); }
.day-pill.is-today { border-color: var(--blue); }
.day-pill-date { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--text-dim); font-weight: 500; }
.day-pill-pnl { font-family: 'DM Mono', monospace; font-size: 14px; font-weight: 600; }
.day-pill-trades { font-size: 10px; color: var(--text-dim); }
.day-pill-status { font-size: 9px; color: var(--text-dim); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

/* ‚îÄ‚îÄ DATA BTN ‚îÄ‚îÄ */
.data-btn { padding: 7px 14px; background: var(--bg); border: 1.5px solid var(--border); color: var(--text-muted); border-radius: var(--radius-sm); font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
.data-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-light); }

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
.login-screen { position: fixed; inset: 0; z-index: 1000; background: linear-gradient(135deg, #eef0ff 0%, #f8f9fc 50%, #f5f3ff 100%); display: flex; align-items: center; justify-content: center; flex-direction: column; }
.login-screen.hidden { display: none; }
.login-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 48px 44px; text-align: center; max-width: 400px; width: 100%; box-shadow: var(--shadow-lg); }
.login-logo-wrap { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 8px; }
.login-logo-mark { width: 44px; height: 44px; border-radius: 12px; background: linear-gradient(135deg, #6366f1, #8b5cf6); display: flex; align-items: center; justify-content: center; font-family: 'Instrument Serif', serif; font-size: 24px; color: white; box-shadow: 0 4px 16px rgba(99,102,241,0.35); }
.login-app-name { font-size: 26px; font-weight: 700; color: var(--text); letter-spacing: -0.5px; }
.login-app-name span { color: var(--accent); }
.login-tagline { font-size: 14px; color: var(--text-muted); margin-bottom: 32px; }
.login-divider { height: 1px; background: var(--border); margin: 20px 0; }
.login-security { font-size: 12px; color: var(--text-muted); line-height: 1.8; }
.login-security span { color: var(--green); font-weight: 600; }
#g_id_signin { display: flex; justify-content: center; margin-bottom: 12px; }

/* ‚îÄ‚îÄ SYNC ‚îÄ‚îÄ */
.sync-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--text-dim); display: inline-block; margin-right: 5px; transition: background 0.3s; }
.sync-dot.syncing { background: var(--amber); animation: pulse-dot 1s infinite; }
.sync-dot.synced { background: var(--green); }
.sync-dot.error { background: var(--red); }
@keyframes pulse-dot { 0%,100%{opacity:1}50%{opacity:0.3} }
.sync-label { font-size: 11px; color: var(--text-muted); font-weight: 500; }
.user-avatar { width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--border); cursor: pointer; }
.sign-out-btn { padding: 6px 12px; background: transparent; border: 1.5px solid var(--border); color: var(--text-muted); border-radius: var(--radius-sm); font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: 'DM Sans', sans-serif; }
.sign-out-btn:hover { border-color: var(--red); color: var(--red); }
.loading-overlay { position: fixed; inset: 0; z-index: 900; background: rgba(248,249,252,0.92); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 16px; }
.loading-overlay.hidden { display: none; }
.spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to{transform:rotate(360deg)} }
.loading-text { font-size: 13px; color: var(--text-muted); font-weight: 500; }
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <div class="login-logo-wrap">
      <div class="login-logo-mark">T</div>
      <div class="login-app-name">Trade<span>Edge</span></div>
    </div>
    <div class="login-tagline">Your private trading journal</div>
    <div id="g_id_signin"></div>
    <div class="login-divider"></div>
    <div class="login-security">
      <span>üîí Secure & Private</span><br>
      Your data is stored exclusively in<br>your own Google Sheet ‚Äî no third party access.
    </div>
  </div>
</div>

<!-- LOADING -->
<div class="loading-overlay hidden" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Loading your journal‚Ä¶</div>
</div>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-mark">T</div>
    <div class="logo-text">Trade<span>Edge</span></div>
  </div>
  <div class="header-right">
    <div class="header-meta">
      <div id="currentDate"></div>
      <div id="currentTime"></div>
    </div>
    <div class="pnl-badge neutral" id="headerPnl">‚Çπ0</div>
    <div style="display:flex;align-items:center;gap:6px">
      <div class="sync-dot" id="syncDot"></div>
      <span class="sync-label" id="syncLabel">Loading‚Ä¶</span>
    </div>
    <button class="data-btn" onclick="exportData()">‚¨á Export</button>
    <img class="user-avatar" id="userAvatar" src="" alt="" style="display:none"/>
    <button class="sign-out-btn" onclick="signOut()">Sign Out</button>
  </div>
</header>

<!-- NAV -->
<div class="nav-tabs">
  <div class="nav-tab active" onclick="switchTab('journal')">üìã Journal</div>
  <div class="nav-tab" onclick="switchTab('calendar')">üìÖ P&amp;L Calendar</div>
  <div class="nav-tab" onclick="switchTab('analytics')">üìä Analytics</div>
</div>

<!-- STATUS BAR -->
<div class="status-bar">
  <div class="status-item"><div class="status-label">Today P&L</div><div class="status-value" id="statPnl">‚Çπ0.00</div></div>
  <div class="status-item"><div class="status-label">Trades</div><div class="status-value gold" id="statTrades">0</div></div>
  <div class="status-item"><div class="status-label">Win Rate</div><div class="status-value" id="statWin">‚Äî</div></div>
  <div class="status-item"><div class="status-label">Total Days</div><div class="status-value gold" id="statDays">‚Äî</div></div>
  <div class="status-item"><div class="status-label">All-Time P&L</div><div class="status-value" id="statAllTime">‚Çπ0</div></div>
  <!-- EDITABLE TARGET -->
  <div class="target-item">
    <div class="status-label">Daily Target</div>
    <div class="target-row">
      <span style="font-size:15px;font-family:'DM Mono',monospace;color:var(--text-muted)">‚Çπ</span>
      <input type="number" class="target-input" id="targetInput" value="5000" title="Click to edit your daily target" onchange="onTargetChange(this.value)" onblur="onTargetChange(this.value)"/>
      <span style="font-size:11px;cursor:pointer;color:var(--text-dim)" title="Edit target" onclick="document.getElementById('targetInput').focus()">‚úèÔ∏è</span>
    </div>
  </div>
  <div class="progress-section">
    <div class="progress-label"><span>Today's Progress</span><span id="progressPct">0%</span></div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
  </div>
  <button class="day-complete-btn" id="dayCompleteBtn" onclick="completeDay()">Mark Day Complete</button>
</div>

<!-- NSE BAR -->
<div class="nse-bar" id="nseBar">
  <div class="nse-bar-label">NSE</div>
  <div id="nseHolidayWrap"></div>
  <div class="nse-news-marquee">
    <div class="nse-news-track" id="nseNewsTrack">
      <div class="nse-news-item"><div class="nse-news-dot"></div>Loading NSE market data‚Ä¶</div>
    </div>
  </div>
</div>

<!-- DATE BAR -->
<div class="active-date-bar">
  <div class="active-date-label">Viewing</div>
  <input type="date" class="date-picker-input" id="datePicker" onchange="onDatePicked(this.value)"/>
  <button class="date-jump-btn today-btn" onclick="jumpToToday()">‚Üê Today</button>
  <div id="viewingPastBadge" class="viewing-past-badge" style="display:none">üìÖ Past Entry Mode</div>
  <div id="activeDatePnlPill" class="date-pnl-pill" style="display:none;border-color:var(--border);color:var(--text-muted)"></div>
  <button class="past-days-toggle" onclick="togglePastDays()" id="pastDaysToggleBtn">üìã All Days ‚ñæ</button>
</div>

<!-- PAST DAYS PANEL -->
<div class="past-days-panel" id="pastDaysPanel">
  <div class="past-days-scroll" id="pastDaysScroll"></div>
</div>

<!-- JOURNAL PAGE -->
<div id="page-journal" class="page active">
  <div class="journal-layout">
    <div class="left-panel">
      <div class="force-stop-banner" id="forceStopBanner">üõë FORCE STOP ‚Äî Daily target hit. No more trades today. Protect your gains.</div>
      <div class="section-title">Log New Trade</div>
      <div class="trade-form">
        <!-- ROW 1: symbol, dir, tf, timeframe -->
        <div class="form-grid">
          <div class="form-group"><label>Symbol</label><input type="text" id="fSymbol" placeholder="NIFTY, BANKNIFTY‚Ä¶"/></div>
          <div class="form-group"><label>Direction</label><select id="fDir"><option value="long">LONG</option><option value="short">SHORT</option></select></div>
          <div class="form-group"><label>Timeframe</label><select id="fTf"><option value="5m">5 min</option><option value="10m">10 min</option><option value="15m">15 min</option><option value="30m">30 min</option><option value="1h">1 hour</option></select></div>
          <div class="form-group"><label>Qty / Lots</label><input type="number" id="fQty" placeholder="1"/></div>
        </div>
        <!-- ROW 2: entry, exit, manual PnL -->
        <div class="form-grid">
          <div class="form-group"><label>Entry ‚Çπ</label><input type="number" id="fEntry" placeholder="0.00" oninput="calcPnl()"/></div>
          <div class="form-group"><label>Exit ‚Çπ</label><input type="number" id="fExit" placeholder="0.00" oninput="calcPnl()"/></div>
          <div class="form-group">
            <label>Final P&amp;L ‚Çπ <span style="font-weight:400;color:var(--accent);font-size:9px;">(override)</span></label>
            <input type="number" id="fPnl" placeholder="Auto-calculated" oninput="onManualPnl()"/>
            <div class="pnl-auto" id="pnlPreview">‚Äî</div>
          </div>
          <div class="form-group"><label>Notes</label><input type="text" id="fNotes" placeholder="Setup, context‚Ä¶"/></div>
        </div>

        <!-- PRE-TRADE CHECKLIST (proper checkboxes) -->
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-dim);margin-bottom:10px;">Pre-Trade Checklist</div>
        <div class="checklist-grid">
          <div class="check-row" onclick="toggleCheckRow(this)" data-idx="0">
            <div class="check-box">‚úì</div>
            <div class="check-content">
              <div class="check-title">5/10 Min Chart Reviewed</div>
              <div class="check-desc">Analysed higher-TF structure before entry</div>
            </div>
          </div>
          <div class="check-row" onclick="toggleCheckRow(this)" data-idx="1">
            <div class="check-box">‚úì</div>
            <div class="check-content">
              <div class="check-title">Buy/Sell Area Identified</div>
              <div class="check-desc">Clear demand/supply zone or key level marked</div>
            </div>
          </div>
          <div class="check-row" onclick="toggleCheckRow(this)" data-idx="2">
            <div class="check-box">‚úì</div>
            <div class="check-content">
              <div class="check-title">FVG Retest Confirmed</div>
              <div class="check-desc">Fair value gap or imbalance retested cleanly</div>
            </div>
          </div>
          <div class="check-row" onclick="toggleCheckRow(this)" data-idx="3">
            <div class="check-box">‚úì</div>
            <div class="check-content">
              <div class="check-title">SL Pre-Defined</div>
              <div class="check-desc">Stop loss set before entry, not after</div>
            </div>
          </div>
        </div>

        <!-- BEHAVIOUR TAGS -->
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-dim);margin-bottom:8px;">Behaviour Tags</div>
        <div class="flag-row">
          <div class="flag-chip delayed-sl" onclick="toggleFlag(this)">‚è± Delayed SL</div>
          <div class="flag-chip revenge" onclick="toggleFlag(this)">üî• Revenge Trade</div>
          <div class="flag-chip risky" onclick="toggleFlag(this)">‚ö° Risky Setup</div>
          <div class="flag-chip fomo" onclick="toggleFlag(this)">üò∞ FOMO Entry</div>
          <div class="flag-chip disciplined" onclick="toggleFlag(this)">‚úÖ Disciplined</div>
        </div>
        <div class="form-actions">
          <button class="btn-secondary" onclick="clearForm()">Clear</button>
          <button class="btn-primary" onclick="logTrade()">Log Trade ‚Üí</button>
        </div>
      </div>
      <div class="section-title" id="tradeLogTitle">Today's Trades</div>
      <div class="log-header"><span>Symbol</span><span>Dir</span><span>Entry</span><span>Exit</span><span>P&L</span><span>TF</span><span>Flags</span><span>Notes</span></div>
      <div id="tradeLog"></div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="right-panel">
      <div class="mindful-section">
        <div class="right-section-title">Mental Edge</div>
        <div class="quote-card">
          <div class="quote-text" id="quoteText"></div>
          <div class="quote-author" id="quoteAuthor"></div>
          <div class="quote-nav">
            <button class="quote-btn" onclick="prevQuote()">‚Üê Prev</button>
            <button class="quote-btn" onclick="nextQuote()">Next ‚Üí</button>
          </div>
        </div>
        <div class="breathing-widget">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:12px;">Box Breathing ‚Äî 4¬∑4¬∑6</div>
          <div class="breath-ring"><div class="breath-ring-fill" id="breathRing"></div></div>
          <div class="breath-label" id="breathLabel">Ready</div>
          <div class="breath-instruction" id="breathInstruction">4 inhale ¬∑ 4 hold ¬∑ 6 exhale</div>
          <button class="breath-btn" id="breathBtn" onclick="toggleBreath()">Start</button>
        </div>
      </div>
      <div class="suggestions-section">
        <div class="right-section-title">Journal Insights</div>
        <div id="suggestions"></div>
      </div>
      <div class="stats-section">
        <div class="right-section-title">Session Stats</div>
        <div class="stats-grid">
          <div class="stat-box"><div class="stat-box-label">Best Trade</div><div class="stat-box-value green" id="bestTrade">‚Äî</div></div>
          <div class="stat-box"><div class="stat-box-label">Worst Trade</div><div class="stat-box-value red" id="worstTrade">‚Äî</div></div>
          <div class="stat-box"><div class="stat-box-label">Avg Winner</div><div class="stat-box-value" id="avgWinner">‚Äî</div></div>
          <div class="stat-box"><div class="stat-box-label">Avg Loser</div><div class="stat-box-value" id="avgLoser">‚Äî</div></div>
          <div class="stat-box"><div class="stat-box-label">Checklist %</div><div class="stat-box-value gold" id="checkScore">‚Äî</div></div>
          <div class="stat-box"><div class="stat-box-label">Discipline</div><div class="stat-box-value" id="disciplineScore">‚Äî</div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- P&L CALENDAR PAGE -->
<div id="page-calendar" class="page">
  <div class="calendar-page">
    <div class="cal-header">
      <div>
        <div class="cal-title">P&amp;L <span>Calendar</span></div>
        <div style="font-size:13px;color:var(--text-muted);margin-top:4px;">Daily, monthly and fiscal year view</div>
      </div>
      <div class="cal-period-tabs">
        <button class="cal-period-tab active" onclick="setCalPeriod('month')">Monthly</button>
        <button class="cal-period-tab" onclick="setCalPeriod('fiscal')">Fiscal Year</button>
        <button class="cal-period-tab" onclick="setCalPeriod('year')">Calendar Year</button>
      </div>
    </div>
    <div class="cal-summary-strip">
      <div class="cal-sum-card"><div class="cal-sum-label">Period P&L</div><div class="cal-sum-value" id="calSumPnl">‚Äî</div><div class="cal-sum-sub" id="calSumPnlSub">‚Äî</div></div>
      <div class="cal-sum-card"><div class="cal-sum-label">Profit Days</div><div class="cal-sum-value" id="calSumWinDays" style="color:var(--green)">‚Äî</div><div class="cal-sum-sub" id="calSumWinSub">‚Äî</div></div>
      <div class="cal-sum-card"><div class="cal-sum-label">Loss Days</div><div class="cal-sum-value" id="calSumLossDays" style="color:var(--red)">‚Äî</div><div class="cal-sum-sub" id="calSumLossSub">‚Äî</div></div>
      <div class="cal-sum-card"><div class="cal-sum-label">Avg Day P&L</div><div class="cal-sum-value" id="calSumAvg">‚Äî</div><div class="cal-sum-sub">per active day</div></div>
    </div>
    <!-- Monthly sub-nav (shown in fiscal/year modes) -->
    <div id="calMonthGrid" style="display:none;display:grid;grid-template-columns:repeat(12,1fr);gap:8px;margin-bottom:20px;"></div>
    <div class="cal-nav">
      <button class="cal-nav-btn" onclick="calNav(-1)">‚Üê</button>
      <div class="cal-nav-label" id="calNavLabel">‚Äî</div>
      <button class="cal-nav-btn" onclick="calNav(1)">‚Üí</button>
      <div id="calNavSub" style="font-size:11px;color:var(--text-muted);margin-left:8px;"></div>
    </div>
    <div class="cal-grid" id="calGrid">
      <div class="cal-weekdays"><div class="cal-weekday">Mon</div><div class="cal-weekday">Tue</div><div class="cal-weekday">Wed</div><div class="cal-weekday">Thu</div><div class="cal-weekday">Fri</div><div class="cal-weekday">Sat</div><div class="cal-weekday">Sun</div></div>
      <div class="cal-days" id="calDays"></div>
    </div>
  </div>
</div>

<!-- ANALYTICS PAGE -->
<div id="page-analytics" class="page">
  <div class="analytics-page">
    <div class="analytics-header">
      <div>
        <div class="analytics-title">Performance <span>Analytics</span></div>
        <div class="analytics-subtitle">vs Nifty 50 & Nifty 500 ‚Äî % Return Normalised</div>
      </div>
      <div class="nifty-status">
        <div class="nifty-badge"><div class="nifty-badge-label" style="color:var(--nifty50-color)">Nifty 50</div><div class="nifty-badge-value" id="n50Value">‚Äî</div><div class="nifty-badge-label" id="n50Change" style="font-size:10px;margin-top:2px;"></div></div>
        <div class="nifty-badge"><div class="nifty-badge-label" style="color:var(--nifty500-color)">Nifty 500</div><div class="nifty-badge-value" id="n500Value">‚Äî</div><div class="nifty-badge-label" id="n500Change" style="font-size:10px;margin-top:2px;"></div></div>
        <div class="nifty-status-text" id="niftyFetchStatus">Fetching index data‚Ä¶</div>
      </div>
    </div>
    <div class="kpi-strip">
      <div class="kpi-card"><div class="kpi-label">Total P&L</div><div class="kpi-value" id="kTotal">‚Çπ0</div><div class="kpi-sub" id="kTotalSub">0 trading days</div></div>
      <div class="kpi-card"><div class="kpi-label">Win Rate</div><div class="kpi-value" id="kWin">‚Äî</div><div class="kpi-sub" id="kWinSub">wins / total</div></div>
      <div class="kpi-card"><div class="kpi-label">Best Day</div><div class="kpi-value green" id="kBestDay">‚Äî</div><div class="kpi-sub" id="kBestDayDate">‚Äî</div></div>
      <div class="kpi-card"><div class="kpi-label">Worst Day</div><div class="kpi-value red" id="kWorstDay">‚Äî</div><div class="kpi-sub" id="kWorstDayDate">‚Äî</div></div>
      <div class="kpi-card"><div class="kpi-label">Avg Day P&L</div><div class="kpi-value" id="kAvgDay">‚Äî</div><div class="kpi-sub">per session</div></div>
      <div class="kpi-card"><div class="kpi-label">Profit Days</div><div class="kpi-value gold" id="kProfitDays">‚Äî</div><div class="kpi-sub">of total days</div></div>
    </div>
    <div class="charts-grid">
      <div class="chart-card full">
        <div class="chart-title">Cumulative % Return vs Nifty Indices</div>
        <div class="chart-subtitle">Normalised to starting capital</div>
        <div class="chart-legend">
          <div class="legend-item"><div class="legend-dot" style="background:var(--trader-color)"></div>Your P&L %</div>
          <div class="legend-item"><div class="legend-dot" style="background:var(--nifty50-color)"></div>Nifty 50</div>
          <div class="legend-item"><div class="legend-dot" style="background:var(--nifty500-color)"></div>Nifty 500</div>
        </div>
        <div id="noDataYearly" class="no-data-msg"><span class="big">üìà</span>Start logging trades to see your cumulative return chart.</div>
        <canvas id="yearlyChart" height="260" style="display:none"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-title">Monthly P&L</div>
        <div class="chart-subtitle">Net profit/loss per calendar month</div>
        <div id="noDataMonthly" class="no-data-msg" style="padding:40px"><span class="big" style="font-size:24px">üìÖ</span>No data yet.</div>
        <canvas id="monthlyChart" height="240" style="display:none"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-title">Weekly P&L</div>
        <div class="chart-subtitle">Net profit/loss per week (last 12 weeks)</div>
        <div id="noDataWeekly" class="no-data-msg" style="padding:40px"><span class="big" style="font-size:24px">üìÜ</span>No data yet.</div>
        <canvas id="weeklyChart" height="240" style="display:none"></canvas>
      </div>
    </div>
    <div class="chart-card" style="margin-bottom:20px;">
      <div class="chart-title">Behaviour Impact Analysis</div>
      <div class="chart-subtitle">How each behaviour tag correlates with your P&L outcomes</div>
      <div class="behaviour-grid" id="behaviourGrid"><div style="text-align:center;padding:24px;color:var(--text-dim);font-size:12px;grid-column:1/-1;">Log trades with behaviour tags to see analysis here.</div></div>
    </div>
    <div class="chart-card" style="margin-bottom:32px;">
      <div class="chart-title">Pre-Trade Checklist Compliance</div>
      <div class="chart-subtitle">% of trades where each analysis step was followed</div>
      <div id="noDataChecklist" class="no-data-msg" style="padding:30px"><span class="big" style="font-size:24px">‚úÖ</span>No data.</div>
      <canvas id="checklistChart" height="140" style="display:none"></canvas>
    </div>
  </div>
</div>

<!-- OVERLAY -->
<div class="overlay" id="overlay">
  <div class="overlay-eyebrow">Session Complete</div>
  <div class="overlay-title">Well Traded.</div>
  <div class="overlay-pnl" id="overlayPnl"></div>
  <div class="overlay-msg" id="overlayMsg"></div>
  <button class="overlay-close" onclick="closeOverlay()">Review Journal</button>
</div>

<script>
// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ
const CONFIG = {
  GOOGLE_CLIENT_ID: '125105345754-91nt9ufd62h7q5cjcft9q5t4mq79ea0d.apps.googleusercontent.com',
  APPS_SCRIPT_URL:  'https://script.google.com/macros/s/AKfycbzJ6zxyo4Z5htVfpTyPyXo3hmkNMVNgEhNFwKaN2I6cY_XU3eVJv8CFQIx4T7RaqKg2Sw/exec',
  STARTING_CAPITAL: 100000,
};

// ‚îÄ‚îÄ NSE HOLIDAYS 2025 (NSE official list) ‚îÄ‚îÄ
const NSE_HOLIDAYS_2025 = {
  '2025-01-26':'Republic Day',
  '2025-02-26':'Mahashivratri',
  '2025-03-14':'Holi',
  '2025-03-31':'Id-Ul-Fitr (Ramzan Id)',
  '2025-04-10':'Shri Ram Navami',
  '2025-04-14':'Dr. Baba Saheb Ambedkar Jayanti',
  '2025-04-18':'Good Friday',
  '2025-05-01':'Maharashtra Day',
  '2025-08-15':'Independence Day',
  '2025-08-27':'Ganesh Chaturthi',
  '2025-10-02':'Mahatma Gandhi Jayanti / Dussehra',
  '2025-10-20':'Diwali - Laxmi Pujan',
  '2025-10-21':'Diwali - Balipratipada',
  '2025-11-05':'Prakash Gurpurb Sri Guru Nanak Dev Ji',
  '2025-12-25':'Christmas',
  // NSE also observes: check nse india.com for exact updated list
};
// 2026 holidays (partial ‚Äî add more as NSE announces)
const NSE_HOLIDAYS_2026 = {
  '2026-01-26':'Republic Day',
  '2026-03-20':'Holi',
  '2026-04-03':'Good Friday',
  '2026-04-14':'Dr. Baba Saheb Ambedkar Jayanti',
  '2026-08-15':'Independence Day',
  '2026-10-02':'Gandhi Jayanti',
  '2026-12-25':'Christmas',
};
const NSE_HOLIDAYS = {...NSE_HOLIDAYS_2025, ...NSE_HOLIDAYS_2026};

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
let currentUser = null;
function handleGoogleSignIn(response) {
  const payload = JSON.parse(atob(response.credential.split('.')[1]));
  currentUser = { email: payload.email, name: payload.name, picture: payload.picture };
  const avatar = document.getElementById('userAvatar');
  avatar.src = currentUser.picture; avatar.style.display = 'block';
  avatar.title = currentUser.name + ' (' + currentUser.email + ')';
  document.getElementById('loginScreen').classList.add('hidden');
  startApp();
}
function signOut() {
  google.accounts.id.disableAutoSelect();
  currentUser = null; state = { days:{}, nifty50:[], nifty500:[] };
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('userAvatar').style.display = 'none';
  setSyncStatus('idle','');
}
function initGoogleSignIn() {
  google.accounts.id.initialize({ client_id: CONFIG.GOOGLE_CLIENT_ID, callback: handleGoogleSignIn, auto_select: true, cancel_on_tap_outside: false });
  google.accounts.id.renderButton(document.getElementById('g_id_signin'), { theme:'outline', size:'large', text:'signin_with', shape:'rectangular', width:300 });
  google.accounts.id.prompt();
}

// ‚îÄ‚îÄ SYNC UI ‚îÄ‚îÄ
function setSyncStatus(status, msg) {
  const dot = document.getElementById('syncDot'); const label = document.getElementById('syncLabel');
  dot.className = 'sync-dot';
  if (status==='syncing') { dot.classList.add('syncing'); label.textContent = msg||'Saving‚Ä¶'; }
  else if (status==='synced') { dot.classList.add('synced'); label.textContent = msg||'Saved ‚úì'; }
  else if (status==='error') { dot.classList.add('error'); label.textContent = msg||'Sync error'; }
  else { label.textContent = msg||''; }
}
function showLoading(msg) { document.getElementById('loadingText').textContent=msg||'Loading‚Ä¶'; document.getElementById('loadingOverlay').classList.remove('hidden'); }
function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }

// ‚îÄ‚îÄ API ‚îÄ‚îÄ
async function apiGet(action, params={}) {
  const url = new URL(CONFIG.APPS_SCRIPT_URL);
  url.searchParams.set('action', action); url.searchParams.set('email', currentUser.email);
  Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
  const r = await fetch(url.toString()); if (!r.ok) throw new Error('API error '+r.status);
  return r.json();
}
async function apiPost(payload) {
  const r = await fetch(CONFIG.APPS_SCRIPT_URL, { method:'POST', body: JSON.stringify({...payload, email:currentUser.email}) });
  if (!r.ok) throw new Error('API error '+r.status); return r.json();
}

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let state = { days:{}, nifty50:[], nifty500:[] };
let activeDate = new Date().toISOString().slice(0,10);
let currentTarget = 5000;
function today() { return new Date().toISOString().slice(0,10); }
function isToday() { return activeDate===today(); }
function activeDayData() { if(!state.days[activeDate]) state.days[activeDate]={trades:[],completed:false}; return state.days[activeDate]; }
function dayPnl(d) {
  // If manualPnl is set on the day, use it. Otherwise sum trades.
  if(d.manualPnl !== undefined && d.manualPnl !== null) return d.manualPnl;
  return (d.trades||[]).reduce((s,t)=>s+t.pnl,0);
}
function isNseHoliday(dateStr) { return NSE_HOLIDAYS[dateStr]; }
function isWeekend(dateStr) { const d=new Date(dateStr+'T00:00:00'); return d.getDay()===0||d.getDay()===6; }

// ‚îÄ‚îÄ TARGET ‚îÄ‚îÄ
function onTargetChange(val) {
  const n = parseFloat(val);
  if(!isNaN(n) && n > 0) { currentTarget = n; updateStats(); checkForceStop(); }
}

// ‚îÄ‚îÄ PERSIST ‚îÄ‚îÄ
async function persistTrade(trade) {
  setSyncStatus('syncing');
  try { await apiPost({action:'saveTrade',date:activeDate,trade}); setSyncStatus('synced'); setTimeout(()=>setSyncStatus('idle',''),2500); }
  catch(e) { setSyncStatus('error','Save failed ‚Äî retrying‚Ä¶'); setTimeout(()=>persistTrade(trade),4000); }
}
async function persistDeleteTrade(tradeId) {
  setSyncStatus('syncing');
  try { await apiPost({action:'deleteTrade',date:activeDate,tradeId}); setSyncStatus('synced'); setTimeout(()=>setSyncStatus('idle',''),2500); }
  catch(e) { setSyncStatus('error','Delete failed'); }
}
async function persistDayComplete() {
  setSyncStatus('syncing');
  try { await apiPost({action:'markDayComplete',date:activeDate,completed:true}); setSyncStatus('synced'); setTimeout(()=>setSyncStatus('idle',''),2500); }
  catch(e) { setSyncStatus('error','Save failed'); }
}
async function loadAllData() {
  showLoading('Loading your trade history‚Ä¶');
  try { const res=await apiGet('getAllDays'); if(res.success) state.days=res.days||{}; }
  catch(e) { setSyncStatus('error','Could not load data'); }
  finally { hideLoading(); }
}
function exportData() {
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`tradeedge-backup-${today()}.json`; a.click();
}

// ‚îÄ‚îÄ P&L FORM CALC ‚îÄ‚îÄ
let manualPnlOverride = false;
function calcPnl() {
  if(manualPnlOverride) return;
  const entry=parseFloat(document.getElementById('fEntry').value);
  const exit=parseFloat(document.getElementById('fExit').value);
  const qty=parseFloat(document.getElementById('fQty').value)||1;
  const dir=document.getElementById('fDir').value;
  const prev=document.getElementById('fPnl');
  const preview=document.getElementById('pnlPreview');
  if(!isNaN(entry)&&!isNaN(exit)) {
    const pnl=parseFloat(((exit-entry)*qty*(dir==='short'?-1:1)).toFixed(2));
    prev.placeholder=`‚Çπ${pnl>=0?'+':''}${pnl.toLocaleString('en-IN')}`;
    preview.textContent=`Auto: ‚Çπ${pnl>=0?'+':''}${pnl.toLocaleString('en-IN')}`;
    preview.className=`pnl-auto ${pnl>=0?'pos':'neg'}`;
  } else {
    prev.placeholder='Auto-calculated'; preview.textContent='‚Äî'; preview.className='pnl-auto';
  }
}
function onManualPnl() {
  const val=document.getElementById('fPnl').value;
  manualPnlOverride=!!val;
  const preview=document.getElementById('pnlPreview');
  if(val) { const n=parseFloat(val); preview.textContent=`Manual: ‚Çπ${n>=0?'+':''}${n.toLocaleString('en-IN')}`; preview.className=`pnl-auto ${n>=0?'pos':'neg'}`; }
  else { preview.textContent='Auto-calc from Entry/Exit'; preview.className='pnl-auto'; }
}

// ‚îÄ‚îÄ QUOTES ‚îÄ‚îÄ
const QUOTES=[
  {text:"The goal of a successful trader is to make the best trades. Money is secondary.",author:"Alexander Elder"},
  {text:"It's not whether you're right or wrong that's important, but how much money you make when you're right.",author:"George Soros"},
  {text:"In trading, the one who knows when to sit tight is right.",author:"Jesse Livermore"},
  {text:"Do not anticipate and move without market confirmation ‚Äî being a little late in your trade is your insurance.",author:"Jesse Livermore"},
  {text:"The elements of good trading are: cutting losses, cutting losses, and cutting losses.",author:"Ed Seykota"},
  {text:"A peak performance trader is totally focused on the present moment regardless of what happened yesterday.",author:"Mark Douglas"},
  {text:"When in doubt, stay out.",author:"Trading Proverb"},
  {text:"Risk comes from not knowing what you are doing.",author:"Warren Buffett"},
  {text:"The most important quality for an investor is temperament, not intellect.",author:"Warren Buffett"},
  {text:"Trade what you see, not what you think.",author:"Linda Bradford Raschke"},
];
let qIdx=0;
function showQuote(i){document.getElementById('quoteText').textContent=QUOTES[i].text;document.getElementById('quoteAuthor').textContent='‚Äî '+QUOTES[i].author;}
function nextQuote(){qIdx=(qIdx+1)%QUOTES.length;showQuote(qIdx);}
function prevQuote(){qIdx=(qIdx-1+QUOTES.length)%QUOTES.length;showQuote(qIdx);}

// ‚îÄ‚îÄ BREATHING ‚îÄ‚îÄ
let breathingActive=false,breathTimeout=null;
function toggleBreath(){
  if(breathingActive){breathingActive=false;clearTimeout(breathTimeout);document.getElementById('breathBtn').textContent='Start';document.getElementById('breathLabel').textContent='Ready';document.getElementById('breathInstruction').textContent='4 inhale ¬∑ 4 hold ¬∑ 6 exhale';document.getElementById('breathRing').className='breath-ring-fill';}
  else{breathingActive=true;document.getElementById('breathBtn').textContent='Stop';runBreathCycle();}
}
function runBreathCycle(){
  if(!breathingActive)return;const ring=document.getElementById('breathRing');
  document.getElementById('breathLabel').textContent='Inhale';document.getElementById('breathInstruction').textContent='breathe in slowly‚Ä¶';ring.className='breath-ring-fill inhale';
  breathTimeout=setTimeout(()=>{if(!breathingActive)return;document.getElementById('breathLabel').textContent='Hold';document.getElementById('breathInstruction').textContent='hold your breath‚Ä¶';ring.className='breath-ring-fill hold';
    breathTimeout=setTimeout(()=>{if(!breathingActive)return;document.getElementById('breathLabel').textContent='Exhale';document.getElementById('breathInstruction').textContent='release slowly‚Ä¶';ring.className='breath-ring-fill exhale';
      breathTimeout=setTimeout(()=>{if(breathingActive)runBreathCycle();},6000);},4000);},4000);
}

// ‚îÄ‚îÄ DATE NAV ‚îÄ‚îÄ
function setActiveDate(date){
  activeDate=date;document.getElementById('datePicker').value=date;
  const isPast=!isToday();
  document.getElementById('viewingPastBadge').style.display=isPast?'flex':'none';
  document.getElementById('dayCompleteBtn').style.display=isPast?'none':'';
  const d=state.days[date];const pill=document.getElementById('activeDatePnlPill');
  if(d&&d.trades&&d.trades.length){const p=dayPnl(d);pill.style.display='flex';pill.textContent=`${p>=0?'+':''}‚Çπ${p.toLocaleString('en-IN')} ¬∑ ${d.trades.length} trade${d.trades.length!==1?'s':''}`;pill.style.borderColor=p>=0?'var(--green)':'var(--red)';pill.style.color=p>=0?'var(--green)':'var(--red)';}
  else{pill.style.display='none';}
  const titleEl=document.getElementById('tradeLogTitle');if(titleEl)titleEl.textContent=isToday()?"Today's Trades":`Trades ‚Äî ${formatDateNice(date)}`;
  const banner=document.getElementById('forceStopBanner');if(isPast){banner.classList.remove('show');}else{checkForceStop();}
  renderTrades();updateStats();generateSuggestions();refreshPastDaysPanel();
}
function jumpToToday(){setActiveDate(today());}
function onDatePicked(val){if(!val)return;if(val>today()){alert("You can't log trades for a future date.");document.getElementById('datePicker').value=activeDate;return;}setActiveDate(val);}
function togglePastDays(){const panel=document.getElementById('pastDaysPanel');const btn=document.getElementById('pastDaysToggleBtn');const isOpen=panel.classList.toggle('open');btn.textContent=isOpen?'üìã All Days ‚ñ¥':'üìã All Days ‚ñæ';if(isOpen)refreshPastDaysPanel();}
function refreshPastDaysPanel(){
  const scroll=document.getElementById('pastDaysScroll');const allDays=Object.keys(state.days).sort().reverse();
  if(!allDays.length){scroll.innerHTML=`<div style="font-size:12px;color:var(--text-dim);padding:8px 0;">No trading days logged yet.</div>`;return;}
  scroll.innerHTML=allDays.map(d=>{const data=state.days[d];const p=dayPnl(data);const pColor=p>0?'var(--green)':p<0?'var(--red)':'var(--text-dim)';const pSign=p>0?'+':'';const isActive=d===activeDate;const isTod=d===today();
    return `<div class="day-pill ${isActive?'active-day':''} ${isTod?'is-today':''}" onclick="setActiveDate('${d}');togglePastDays()"><div class="day-pill-date">${isTod?'TODAY':d.slice(5)}</div><div class="day-pill-pnl" style="color:${pColor}">${pSign}‚Çπ${Math.abs(p).toLocaleString('en-IN')}</div><div class="day-pill-trades">${(data.trades||[]).length} trades</div><div class="day-pill-status">${data.completed?'‚úì done':isTod?'active':'‚Äî'}</div></div>`;
  }).join('');
}
function formatDateNice(ds){return new Date(ds+'T00:00:00').toLocaleDateString('en-IN',{weekday:'short',day:'2-digit',month:'short',year:'numeric'});}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
function switchTab(tab){
  document.querySelectorAll('.nav-tab').forEach((t,i)=>t.classList.toggle('active',['journal','calendar','analytics'][i]===tab));
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+tab).classList.add('active');
  if(tab==='analytics')buildAnalytics();
  if(tab==='calendar')buildCalendar();
}

// ‚îÄ‚îÄ FORM ‚îÄ‚îÄ
function toggleCheckRow(el){el.classList.toggle('checked');}
function toggleFlag(el){el.classList.toggle('active');}
function clearForm(){
  ['fSymbol','fEntry','fExit','fQty','fNotes','fPnl'].forEach(id=>document.getElementById(id).value='');
  document.querySelectorAll('.check-row').forEach(c=>c.classList.remove('checked'));
  document.querySelectorAll('.flag-chip').forEach(f=>f.classList.remove('active'));
  manualPnlOverride=false;
  document.getElementById('pnlPreview').textContent='‚Äî';
  document.getElementById('pnlPreview').className='pnl-auto';
  document.getElementById('fPnl').placeholder='Auto-calculated';
}

async function logTrade(){
  if(activeDayData().completed){alert('This day is marked complete.');return;}
  const symbol=document.getElementById('fSymbol').value.trim().toUpperCase();
  const dir=document.getElementById('fDir').value;const tf=document.getElementById('fTf').value;
  const entry=parseFloat(document.getElementById('fEntry').value)||0;
  const exit=parseFloat(document.getElementById('fExit').value)||0;
  const qty=parseFloat(document.getElementById('fQty').value)||1;
  const notes=document.getElementById('fNotes').value.trim();
  const manualVal=document.getElementById('fPnl').value;
  if(!symbol){alert('Please enter a Symbol.');return;}

  let pnl;
  if(manualVal!==''){
    pnl=parseFloat(manualVal);
    if(isNaN(pnl)){alert('Invalid P&L value.');return;}
  } else {
    pnl=parseFloat(((exit-entry)*qty*(dir==='short'?-1:1)).toFixed(2));
  }

  const checks=[...document.querySelectorAll('.check-row')].map(c=>c.classList.contains('checked'));
  const flags=[...document.querySelectorAll('.flag-chip.active')].map(f=>f.textContent.trim());
  const trade={id:Date.now(),symbol,dir,tf,entry,exit,qty,pnl,checks,flags,notes,manualPnl:(manualVal!==''),time:new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})};
  activeDayData().trades.push(trade);
  renderTrades();updateStats();generateSuggestions();clearForm();if(isToday())checkForceStop();refreshPastDaysPanel();setActiveDate(activeDate);
  await persistTrade(trade);
}
async function deleteTrade(id){
  activeDayData().trades=activeDayData().trades.filter(t=>t.id!==id);
  renderTrades();updateStats();generateSuggestions();refreshPastDaysPanel();setActiveDate(activeDate);
  await persistDeleteTrade(id);
}

// ‚îÄ‚îÄ RENDER TRADES ‚îÄ‚îÄ
function renderTrades(){
  const log=document.getElementById('tradeLog');const trades=activeDayData().trades;const isPast=!isToday();
  if(!trades.length){log.innerHTML=`<div class="empty-state"><span class="icon">üìã</span>${isPast?`No trades logged for ${formatDateNice(activeDate)}.`:'No trades logged today. Add your first trade above.'}</div>`;return;}
  log.innerHTML=[...trades].reverse().map(t=>{
    const pnlCls=t.pnl>=0?'pos':'neg';const pnlSign=t.pnl>=0?'+':'';
    const flagHtml=t.flags.map(f=>{let cls='mf-disciplined';if(f.includes('Delayed'))cls='mf-delayed';else if(f.includes('Revenge'))cls='mf-revenge';else if(f.includes('Risky'))cls='mf-risky';else if(f.includes('FOMO'))cls='mf-fomo';return `<span class="mini-flag ${cls}">${f.replace(/[üî•‚è±‚ö°üò∞‚úÖ]/g,'').trim()}</span>`;}).join('');
    const ciHtml=['üìä','üìç','üîç','üõ°'].map((ic,i)=>`<span class="ci ${t.checks[i]?'ok':''}" title="${['Chart TF','Buy/Sell','FVG Retest','SL Defined'][i]}">${ic}</span>`).join('');
    const manualTag=t.manualPnl?`<span style="font-size:9px;background:var(--amber-light);color:var(--amber);border-radius:4px;padding:1px 4px;margin-left:2px;font-weight:700;">M</span>`:'';
    return `<div class="trade-row"><span class="trade-symbol">${t.symbol}</span><span class="trade-dir ${t.dir}">${t.dir.toUpperCase()}</span><span class="trade-col">${t.entry?'‚Çπ'+t.entry:'‚Äî'}</span><span class="trade-col">${t.exit?'‚Çπ'+t.exit:'‚Äî'}</span><span class="trade-pnl ${pnlCls}">${pnlSign}‚Çπ${Math.abs(t.pnl).toLocaleString('en-IN')}${manualTag}</span><span class="trade-col">${t.tf}</span><div><div style="display:flex;flex-wrap:wrap;gap:2px">${flagHtml}</div><div style="display:flex;gap:3px;margin-top:3px">${ciHtml}</div></div><div style="display:flex;align-items:center;gap:6px;overflow:hidden;"><span class="trade-col" style="font-size:11px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1" title="${t.notes}">${t.notes||'‚Äî'}</span><button class="delete-trade" onclick="deleteTrade(${t.id})" title="Delete">‚úï</button></div></div>`;
  }).join('');
}

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ
function updateStats(){
  const trades=activeDayData().trades;const pnl=dayPnl(activeDayData());
  const wins=trades.filter(t=>t.pnl>0),losses=trades.filter(t=>t.pnl<0);const wr=trades.length?Math.round((wins.length/trades.length)*100):null;
  document.getElementById('statPnl').textContent=`‚Çπ${pnl.toLocaleString('en-IN',{minimumFractionDigits:2})}`;document.getElementById('statPnl').className=`status-value ${pnl>0?'green':pnl<0?'red':''}`;
  document.getElementById('statTrades').textContent=trades.length;document.getElementById('statWin').textContent=wr!==null?`${wr}%`:'‚Äî';document.getElementById('statWin').className=`status-value ${wr>=50?'green':'red'}`;
  const allDays=Object.keys(state.days);document.getElementById('statDays').textContent=allDays.length;
  const allPnl=Object.values(state.days).reduce((s,d)=>s+dayPnl(d),0);const apEl=document.getElementById('statAllTime');apEl.textContent=`‚Çπ${allPnl.toLocaleString('en-IN',{minimumFractionDigits:0})}`;apEl.className=`status-value ${allPnl>0?'green':allPnl<0?'red':''}`;
  const pct=Math.min(100,Math.max(0,(pnl/currentTarget)*100));document.getElementById('progressFill').style.width=pct+'%';document.getElementById('progressPct').textContent=Math.round(pct)+'%';
  const hPnl=document.getElementById('headerPnl');hPnl.textContent=`${pnl>=0?'+':''}‚Çπ${pnl.toLocaleString('en-IN',{minimumFractionDigits:0})}`;hPnl.className=`pnl-badge ${pnl>0?'profit':pnl<0?'loss':'neutral'}`;
  const bestPnl=wins.length?Math.max(...wins.map(t=>t.pnl)):null;const worstPnl=losses.length?Math.min(...losses.map(t=>t.pnl)):null;
  const avgW=wins.length?wins.reduce((s,t)=>s+t.pnl,0)/wins.length:null;const avgL=losses.length?losses.reduce((s,t)=>s+t.pnl,0)/losses.length:null;
  document.getElementById('bestTrade').textContent=bestPnl?`+‚Çπ${bestPnl.toLocaleString('en-IN')}`:'‚Äî';document.getElementById('worstTrade').textContent=worstPnl?`‚Çπ${worstPnl.toLocaleString('en-IN')}`:'‚Äî';
  document.getElementById('avgWinner').textContent=avgW?`+‚Çπ${avgW.toFixed(0)}`:'‚Äî';document.getElementById('avgLoser').textContent=avgL?`‚Çπ${avgL.toFixed(0)}`:'‚Äî';
  if(trades.length){const tc=trades.reduce((s,t)=>s+t.checks.filter(Boolean).length,0);document.getElementById('checkScore').textContent=Math.round((tc/(trades.length*4))*100)+'%';}else{document.getElementById('checkScore').textContent='‚Äî';}
  const badFlags=trades.reduce((s,t)=>s+t.flags.filter(f=>!f.includes('‚úÖ')).length,0);const discFlags=trades.reduce((s,t)=>s+t.flags.filter(f=>f.includes('‚úÖ')).length,0);
  document.getElementById('disciplineScore').textContent=trades.length?`${discFlags}‚úÖ ${badFlags}‚ö†Ô∏è`:'‚Äî';
}

// ‚îÄ‚îÄ SUGGESTIONS ‚îÄ‚îÄ
function generateSuggestions(){
  const trades=activeDayData().trades;const pnl=dayPnl(activeDayData());
  const wins=trades.filter(t=>t.pnl>0),losses=trades.filter(t=>t.pnl<0);
  const hasDelayed=trades.some(t=>t.flags.some(f=>f.includes('Delayed')));const hasRevenge=trades.some(t=>t.flags.some(f=>f.includes('Revenge')));const hasRisky=trades.some(t=>t.flags.some(f=>f.includes('Risky')));
  const recentLoss=[...trades].slice(-3).filter(t=>t.pnl<0).length;const checkPct=trades.length?trades.reduce((s,t)=>s+t.checks.filter(Boolean).length,0)/(trades.length*4):1;
  let cards=[];
  if(pnl>=currentTarget)cards.push({type:'positive',label:'üéØ Target Reached',text:`You've hit ‚Çπ${currentTarget.toLocaleString('en-IN')}. No more trades today ‚Äî protect your gains.`});
  if(hasDelayed)cards.push({type:'warning',label:'‚è± Delayed SL Detected',text:'Pre-define your SL before entry and honour it immediately.'});
  if(hasRevenge)cards.push({type:'danger',label:'üî• Revenge Trading Alert',text:'Step away for 10 minutes. Use the breathing exercise. Revenge trades are emotional, not analytical.'});
  if(recentLoss>=2)cards.push({type:'danger',label:'üìâ Consecutive Losses',text:`${recentLoss} of your last 3 trades are losses. Take a short break to reset.`});
  if(checkPct<0.6&&trades.length>0)cards.push({type:'warning',label:'üìã Low Checklist Compliance',text:'Less than 60% of your checklist items were completed before trades.'});
  if(wins.length>0&&losses.length>0){const avgW=wins.reduce((s,t)=>s+t.pnl,0)/wins.length;const avgL=Math.abs(losses.reduce((s,t)=>s+t.pnl,0)/losses.length);const rr=avgW/avgL;if(rr<1)cards.push({type:'warning',label:'‚öñÔ∏è R:R Below 1:1',text:`Avg winner ‚Çπ${avgW.toFixed(0)} vs avg loser ‚Çπ${avgL.toFixed(0)}. Let winners run further.`});else cards.push({type:'positive',label:'‚öñÔ∏è Solid R:R Ratio',text:`Your R:R is ${rr.toFixed(2)}:1 today. Keep cutting losers and letting winners breathe.`});}
  if(hasRisky)cards.push({type:'info',label:'‚ö° Risky Setup Logged',text:'Track risky setups in Analytics to see if they net positive over time.'});
  if(!cards.length&&trades.length>0)cards.push({type:'info',label:'üìä Clean Session',text:'No red flags. Keep following your checklist and honouring your SL.'});
  if(!trades.length)cards.push({type:'info',label:'üìä Getting Started',text:'Log your first trade to see personalised insights based on your behaviour patterns.'});
  document.getElementById('suggestions').innerHTML=cards.map(c=>`<div class="suggestion-card ${c.type}"><div class="suggestion-label">${c.label}</div>${c.text}</div>`).join('');
}

// ‚îÄ‚îÄ FORCE STOP / DAY COMPLETE ‚îÄ‚îÄ
function checkForceStop(){const pnl=dayPnl(activeDayData());if(pnl>=currentTarget)document.getElementById('forceStopBanner').classList.add('show');}
async function completeDay(){
  activeDayData().completed=true;document.getElementById('dayCompleteBtn').classList.add('done');document.getElementById('dayCompleteBtn').textContent='‚úì Day Complete';
  const trades=activeDayData().trades;const pnl=dayPnl(activeDayData());const wins=trades.filter(t=>t.pnl>0);const wr=trades.length?Math.round((wins.length/trades.length)*100):0;
  document.getElementById('overlayPnl').textContent=`${pnl>=0?'+':''}‚Çπ${pnl.toLocaleString('en-IN',{minimumFractionDigits:2})}`;document.getElementById('overlayPnl').style.color=pnl>=0?'var(--green)':'var(--red)';
  const hasIssues=trades.some(t=>t.flags.some(f=>f.includes('Revenge')||f.includes('Delayed')));
  if(pnl>=currentTarget)document.getElementById('overlayMsg').textContent=`Target achieved in ${trades.length} trades (${wr}% win rate). Force Stop was the right call.`;
  else if(pnl>0)document.getElementById('overlayMsg').textContent=`Profitable day ‚Äî ‚Çπ${pnl.toFixed(0)} with ${wr}% win rate. ${hasIssues?'Review the flagged trades.':'Clean execution today.'}`;
  else document.getElementById('overlayMsg').textContent=`Loss day of ‚Çπ${Math.abs(pnl).toFixed(0)}. Review flagged trades. Losses are part of the game ‚Äî learn and reset.`;
  document.getElementById('overlay').classList.add('show');await persistDayComplete();
}
function closeOverlay(){document.getElementById('overlay').classList.remove('show');}

// ‚îÄ‚îÄ NSE BAR ‚îÄ‚îÄ
async function initNseBar() {
  const todayStr=today();
  const holiday=isNseHoliday(todayStr);
  const wrap=document.getElementById('nseHolidayWrap');
  if(holiday) {
    wrap.innerHTML=`<div class="nse-holiday-badge">üèñ Market Holiday: ${holiday}</div>`;
  } else if(isWeekend(todayStr)) {
    wrap.innerHTML=`<div class="nse-holiday-badge">üîí Weekend ‚Äî Markets Closed</div>`;
  }
  // Fetch recent NSE announcements via a CORS-friendly approach (using Yahoo Finance news)
  const newsItems = [
    'NSE market timings: 9:15 AM ‚Äì 3:30 PM IST',
    'Equity segment pre-open: 9:00 AM ‚Äì 9:15 AM IST',
    'F&O expiry: Thursday of each week',
    'Next scheduled NSE holiday: ' + getNextHoliday(),
    'NSE normal market hours: Monday to Friday',
    'Visit nseindia.com for live indices and announcements',
  ];
  const track=document.getElementById('nseNewsTrack');
  const doubled=[...newsItems,...newsItems];
  track.innerHTML=doubled.map(item=>`<div class="nse-news-item"><div class="nse-news-dot"></div>${item}</div>`).join('');
}
function getNextHoliday(){
  const todayStr=today();
  const upcoming=Object.entries(NSE_HOLIDAYS).filter(([d])=>d>todayStr).sort(([a],[b])=>a.localeCompare(b));
  if(!upcoming.length)return'Check nseindia.com';
  const [d,name]=upcoming[0];return`${name} (${new Date(d+'T00:00:00').toLocaleDateString('en-IN',{day:'2-digit',month:'short'})})`;
}

// ‚îÄ‚îÄ NIFTY ‚îÄ‚îÄ
async function fetchNiftyData(){
  const status=document.getElementById('niftyFetchStatus');
  try{
    const ft=async(ticker)=>{const url=`https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(ticker)}?range=1y&interval=1d`;const r=await fetch(url);if(!r.ok)throw new Error('fail');const json=await r.json();const ts=json.chart.result[0].timestamp;const closes=json.chart.result[0].indicators.quote[0].close;return ts.map((t,i)=>({date:new Date(t*1000).toISOString().slice(0,10),close:closes[i]})).filter(d=>d.close!=null);};
    const[n50,n500]=await Promise.all([ft('^NSEI'),ft('^CRSLDX')]);
    state.nifty50=n50;state.nifty500=n500;
    if(n50.length){const last=n50[n50.length-1],prev=n50[n50.length-2];const chg=prev?((last.close-prev.close)/prev.close*100).toFixed(2):'‚Äî';document.getElementById('n50Value').textContent=last.close.toFixed(0);document.getElementById('n50Change').textContent=`${chg>0?'+':''}${chg}% today`;document.getElementById('n50Change').style.color=chg>=0?'var(--green)':'var(--red)';}
    if(n500.length){const last=n500[n500.length-1],prev=n500[n500.length-2];const chg=prev?((last.close-prev.close)/prev.close*100).toFixed(2):'‚Äî';document.getElementById('n500Value').textContent=last.close.toFixed(0);document.getElementById('n500Change').textContent=`${chg>0?'+':''}${chg}% today`;document.getElementById('n500Change').style.color=chg>=0?'var(--green)':'var(--red)';}
    status.textContent=`Updated ${new Date().toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})}`;status.style.color='var(--green)';
  }catch(e){status.textContent='Index data unavailable';status.style.color='var(--amber)';}
}

// ‚îÄ‚îÄ P&L CALENDAR ‚îÄ‚îÄ
let calPeriod='month';
let calYear=new Date().getFullYear();
let calMonth=new Date().getMonth(); // 0-indexed

function setCalPeriod(p){
  calPeriod=p;
  document.querySelectorAll('.cal-period-tab').forEach((t,i)=>t.classList.toggle('active',['month','fiscal','year'][i]===p));
  if(p==='month'){calYear=new Date().getFullYear();calMonth=new Date().getMonth();}
  if(p==='fiscal'){calYear=getFiscalYear();}
  if(p==='year'){calYear=new Date().getFullYear();}
  buildCalendar();
}
function getFiscalYear(){const now=new Date();return now.getMonth()>=3?now.getFullYear():now.getFullYear()-1;}
function calNav(dir){
  if(calPeriod==='month'){calMonth+=dir;if(calMonth>11){calMonth=0;calYear++;}if(calMonth<0){calMonth=11;calYear--;}}
  else{calYear+=dir;}
  buildCalendar();
}

function buildCalendar(){
  if(calPeriod==='month') buildMonthCalendar(calYear,calMonth);
  else if(calPeriod==='fiscal') buildFiscalCalendar(calYear);
  else buildYearCalendar(calYear);
}

function buildMonthCalendar(year,month){
  const monthName=new Date(year,month,1).toLocaleDateString('en-IN',{month:'long',year:'numeric'});
  document.getElementById('calNavLabel').textContent=monthName;
  document.getElementById('calNavSub').textContent='';
  // Gather days for this month
  const firstDay=new Date(year,month,1);const lastDay=new Date(year,month+1,0);
  // start on Monday
  let startDow=(firstDay.getDay()+6)%7; // Mon=0
  const daysInMonth=lastDay.getDate();
  // Build day data
  const dayMap=buildDayMap();
  // Summary
  let periodPnl=0,winDays=0,lossDays=0,activeDays=0;
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    if(dayMap[ds]!==undefined){periodPnl+=dayMap[ds].pnl;activeDays++;if(dayMap[ds].pnl>0)winDays++;if(dayMap[ds].pnl<0)lossDays++;}
  }
  updateCalSummary(periodPnl,winDays,lossDays,activeDays,'month');
  // Render
  let html='';
  for(let i=0;i<startDow;i++) html+=`<div class="cal-day empty"></div>`;
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    html+=renderCalDay(ds,d);
  }
  document.getElementById('calDays').innerHTML=html;
}

function buildFiscalCalendar(fy){
  // Indian fiscal: Apr fy to Mar fy+1
  document.getElementById('calNavLabel').textContent=`FY ${fy}‚Äì${String(fy+1).slice(-2)}`;
  const months=['Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec','Jan','Feb','Mar'];
  const dayMap=buildDayMap();
  let periodPnl=0,winDays=0,lossDays=0,activeDays=0;
  // Show one-month grid for the fiscal year ‚Äî let's show the whole year stacked
  // Show current or first month of FY in main grid; show month-level summary above
  const fyMonths=[];for(let m=3;m<12;m++)fyMonths.push({y:fy,m});for(let m=0;m<3;m++)fyMonths.push({y:fy+1,m});
  let monthHtml='';
  fyMonths.forEach(({y,m})=>{
    const mn=new Date(y,m,1);const key=mn.toLocaleDateString('en-IN',{month:'short'});
    let mPnl=0;const daysInM=new Date(y,m+1,0).getDate();
    for(let d=1;d<=daysInM;d++){const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;if(dayMap[ds])mPnl+=dayMap[ds].pnl;}
    periodPnl+=mPnl;
    const col=mPnl>0?'var(--green)':mPnl<0?'var(--red)':'var(--text-dim)';
    monthHtml+=`<div onclick="calPeriod='month';calYear=${y};calMonth=${m};buildCalendar();" style="padding:10px 8px;background:var(--surface);border:1.5px solid ${mPnl>0?'#6ee7b7':mPnl<0?'#fca5a5':'var(--border)'};border-radius:var(--radius-sm);cursor:pointer;text-align:center;transition:all 0.15s;"><div style="font-size:10px;font-weight:700;color:var(--text-dim);margin-bottom:4px;">${key}</div><div style="font-family:'DM Mono',monospace;font-size:13px;font-weight:600;color:${col}">${mPnl!==0?(mPnl>0?'+':'')+mPnl.toLocaleString('en-IN',{maximumFractionDigits:0}):'‚Äî'}</div></div>`;
  });
  const mgEl=document.getElementById('calMonthGrid');mgEl.innerHTML=monthHtml;mgEl.style.display='grid';
  // Also show the current fiscal month in the day view
  const now=new Date();let showY=fy,showM=3;
  // find current month in fiscal
  if(now.getFullYear()===fy&&now.getMonth()>=3){showY=fy;showM=now.getMonth();}
  else if(now.getFullYear()===fy+1&&now.getMonth()<3){showY=fy+1;showM=now.getMonth();}
  calMonth=showM;
  document.getElementById('calNavSub').textContent='Click a month above to drill down';
  // calc summary
  fyMonths.forEach(({y,m})=>{const daysInM=new Date(y,m+1,0).getDate();for(let d=1;d<=daysInM;d++){const ds=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;if(dayMap[ds]){activeDays++;if(dayMap[ds].pnl>0)winDays++;if(dayMap[ds].pnl<0)lossDays++;}}});
  updateCalSummary(periodPnl,winDays,lossDays,activeDays,'fiscal');
  buildMonthCalendar(showY,showM);
}

function buildYearCalendar(year){
  document.getElementById('calNavLabel').textContent=`Year ${year}`;
  const dayMap=buildDayMap();
  let periodPnl=0,winDays=0,lossDays=0,activeDays=0;
  // Month overview
  let monthHtml='';
  for(let m=0;m<12;m++){
    const daysInM=new Date(year,m+1,0).getDate();let mPnl=0;
    for(let d=1;d<=daysInM;d++){const ds=`${year}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;if(dayMap[ds]){mPnl+=dayMap[ds].pnl;periodPnl+=dayMap[ds].pnl;activeDays++;if(dayMap[ds].pnl>0)winDays++;if(dayMap[ds].pnl<0)lossDays++;}}
    const mn=new Date(year,m,1).toLocaleDateString('en-IN',{month:'short'});const col=mPnl>0?'var(--green)':mPnl<0?'var(--red)':'var(--text-dim)';
    monthHtml+=`<div onclick="calPeriod='month';calYear=${year};calMonth=${m};buildCalendar();" style="padding:10px 8px;background:var(--surface);border:1.5px solid ${mPnl>0?'#6ee7b7':mPnl<0?'#fca5a5':'var(--border)'};border-radius:var(--radius-sm);cursor:pointer;text-align:center;transition:all 0.15s;"><div style="font-size:10px;font-weight:700;color:var(--text-dim);margin-bottom:4px;">${mn}</div><div style="font-family:'DM Mono',monospace;font-size:13px;font-weight:600;color:${col}">${mPnl!==0?(mPnl>0?'+':'')+mPnl.toLocaleString('en-IN',{maximumFractionDigits:0}):'‚Äî'}</div></div>`;
  }
  const mgEl=document.getElementById('calMonthGrid');mgEl.innerHTML=monthHtml;mgEl.style.display='grid';
  document.getElementById('calNavSub').textContent='Click a month above to drill down';
  updateCalSummary(periodPnl,winDays,lossDays,activeDays,'year');
  buildMonthCalendar(year,new Date().getMonth());
}

function buildDayMap(){
  const map={};
  Object.entries(state.days).forEach(([d,data])=>{map[d]={pnl:dayPnl(data),trades:(data.trades||[]).length,completed:data.completed};});
  return map;
}
function updateCalSummary(pnl,win,loss,active,period){
  const pfx=pnl>=0?'+':'';
  document.getElementById('calSumPnl').textContent=`‚Çπ${pfx}${pnl.toLocaleString('en-IN',{maximumFractionDigits:0})}`;
  document.getElementById('calSumPnl').style.color=pnl>0?'var(--green)':pnl<0?'var(--red)':'var(--text)';
  document.getElementById('calSumPnlSub').textContent={month:'This month',fiscal:'This fiscal year',year:'This calendar year'}[period];
  document.getElementById('calSumWinDays').textContent=win;
  document.getElementById('calSumWinSub').textContent=`${active?Math.round((win/active)*100):0}% of trading days`;
  document.getElementById('calSumLossDays').textContent=loss;
  document.getElementById('calSumLossSub').textContent=`${active?Math.round((loss/active)*100):0}% of trading days`;
  const avg=active?pnl/active:0;document.getElementById('calSumAvg').textContent=active?`‚Çπ${(avg>=0?'+':'')+avg.toFixed(0)}`:'‚Äî';
  document.getElementById('calSumAvg').style.color=avg>0?'var(--green)':avg<0?'var(--red)':'var(--text)';
}
function renderCalDay(ds,dayNum){
  const todayStr=today();const isT=ds===todayStr;const weekend=isWeekend(ds);const holiday=isNseHoliday(ds);
  const dayMap=buildDayMap();const data=dayMap[ds];
  let cls='cal-day';if(weekend)cls+=' weekend';if(holiday)cls+=' holiday';if(isT)cls+=' today';if(data)cls+=' has-data';
  const numHtml=isT?`<div class="cal-day-today-dot">${dayNum}</div>`:`<span>${dayNum}</span>`;
  let inner='';
  if(holiday)inner+=`<div class="cal-day-holiday-label">${holiday}</div>`;
  if(data){
    const p=data.pnl;const sign=p>=0?'+':'';const col=p>0?'pos':'neg';
    inner+=`<div class="cal-day-pnl ${col}">${sign}‚Çπ${Math.abs(p).toLocaleString('en-IN',{maximumFractionDigits:0})}</div>`;
    inner+=`<div class="cal-day-trades">${data.trades} trade${data.trades!==1?'s':''} ${data.completed?'<span class="cal-day-complete-dot"></span>':''}</div>`;
    inner+=`<div class="cal-day-bar ${col}"></div>`;
  }
  const clickable=data?`onclick="setActiveDate('${ds}');switchTab('journal');"` :'';
  return `<div class="${cls}" ${clickable}><div class="cal-day-num">${numHtml}</div>${inner}</div>`;
}

// ‚îÄ‚îÄ ANALYTICS ‚îÄ‚îÄ
let charts={};
function destroyChart(id){if(charts[id]){charts[id].destroy();delete charts[id];}}
function getChartDefaults(){return{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false},tooltip:{backgroundColor:'#fff',borderColor:'#e2e8f0',borderWidth:1,titleColor:'#0f172a',bodyColor:'#64748b',titleFont:{family:"'DM Sans',sans-serif",size:12,weight:'600'},bodyFont:{family:"'DM Mono',monospace",size:11},padding:12,callbacks:{}}},scales:{x:{grid:{color:'rgba(226,232,240,0.8)',drawBorder:false},ticks:{color:'#94a3b8',font:{family:"'DM Mono',monospace",size:10},maxRotation:0}},y:{grid:{color:'rgba(226,232,240,0.8)',drawBorder:false},ticks:{color:'#94a3b8',font:{family:"'DM Mono',monospace",size:10}}}}};}
function buildAnalytics(){
  const allDays=Object.keys(state.days).sort();
  if(!allDays.length){['noDataYearly','noDataMonthly','noDataWeekly','noDataChecklist'].forEach(id=>document.getElementById(id).style.display='block');['yearlyChart','monthlyChart','weeklyChart','checklistChart'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none';});updateKPIs(allDays);return;}
  updateKPIs(allDays);buildYearlyChart(allDays);buildMonthlyChart(allDays);buildWeeklyChart(allDays);buildBehaviourGrid(allDays);buildChecklistChart(allDays);
}
function updateKPIs(allDays){
  const allTrades=allDays.flatMap(d=>(state.days[d].trades||[]));const allWins=allTrades.filter(t=>t.pnl>0);const totalPnl=allDays.reduce((s,d)=>s+dayPnl(state.days[d]),0);const wr=allTrades.length?Math.round((allWins.length/allTrades.length)*100):null;
  const dayPnls=allDays.map(d=>({date:d,pnl:dayPnl(state.days[d])}));const profitDays=dayPnls.filter(d=>d.pnl>0);
  const bestDay=dayPnls.reduce((a,b)=>b.pnl>a.pnl?b:a,{pnl:-Infinity,date:'‚Äî'});const worstDay=dayPnls.reduce((a,b)=>b.pnl<a.pnl?b:a,{pnl:Infinity,date:'‚Äî'});
  const el=id=>document.getElementById(id);
  el('kTotal').textContent=`‚Çπ${totalPnl.toLocaleString('en-IN',{minimumFractionDigits:0})}`;el('kTotal').className=`kpi-value ${totalPnl>0?'green':totalPnl<0?'red':''}`;el('kTotalSub').textContent=`${allDays.length} trading day${allDays.length!==1?'s':''}`;
  el('kWin').textContent=wr!==null?`${wr}%`:'‚Äî';el('kWin').className=`kpi-value ${wr>=50?'green':'red'}`;el('kWinSub').textContent=`${allWins.length} / ${allTrades.length} trades`;
  el('kBestDay').textContent=bestDay.pnl>-Infinity?`+‚Çπ${bestDay.pnl.toLocaleString('en-IN')}`:'‚Äî';el('kBestDayDate').textContent=bestDay.date!=='‚Äî'?bestDay.date:'‚Äî';
  el('kWorstDay').textContent=worstDay.pnl<Infinity?`‚Çπ${worstDay.pnl.toLocaleString('en-IN')}`:'‚Äî';el('kWorstDayDate').textContent=worstDay.date!=='‚Äî'?worstDay.date:'‚Äî';
  el('kAvgDay').textContent=allDays.length?`‚Çπ${(totalPnl/allDays.length).toFixed(0)}`:'‚Äî';el('kAvgDay').className=`kpi-value ${(totalPnl/allDays.length)>0?'green':'red'}`;
  el('kProfitDays').textContent=allDays.length?`${profitDays.length}/${allDays.length}`:'‚Äî';
}
function buildYearlyChart(allDays){
  destroyChart('yearly');document.getElementById('noDataYearly').style.display='none';const canvas=document.getElementById('yearlyChart');canvas.style.display='block';
  const traderByDate={};let cum=0;allDays.forEach(d=>{cum+=dayPnl(state.days[d]);traderByDate[d]=(cum/CONFIG.STARTING_CAPITAL)*100;});
  const startDate=allDays[0];const n50f=(state.nifty50||[]).filter(d=>d.date>=startDate);const n500f=(state.nifty500||[]).filter(d=>d.date>=startDate);
  function normPct(arr){if(!arr.length)return[];const base=arr[0].close;return arr.map(d=>({date:d.date,pct:((d.close-base)/base)*100}));}
  const n50pct=normPct(n50f),n500pct=normPct(n500f);
  const allDates=[...new Set([...allDays,...n50pct.map(d=>d.date),...n500pct.map(d=>d.date)])].sort().slice(-365);
  const n50map=Object.fromEntries(n50pct.map(d=>[d.date,d.pct]));const n500map=Object.fromEntries(n500pct.map(d=>[d.date,d.pct]));
  let lt=0,ln50=null,ln500=null;
  const traderSeries=allDates.map(d=>{if(traderByDate[d]!==undefined)lt=traderByDate[d];return lt;});
  const n50series=allDates.map(d=>{if(n50map[d]!==undefined)ln50=n50map[d];return ln50;});
  const n500series=allDates.map(d=>{if(n500map[d]!==undefined)ln500=n500map[d];return ln500;});
  const step=Math.max(1,Math.floor(allDates.length/12));const labels=allDates.map((d,i)=>i%step===0?d.slice(5):'');
  const cfg=getChartDefaults();cfg.plugins.tooltip.callbacks.label=ctx=>`${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%`;cfg.scales.y.ticks.callback=v=>v.toFixed(1)+'%';
  cfg.plugins.legend={display:true,labels:{color:'#64748b',font:{family:"'DM Sans',sans-serif",size:11},boxWidth:24,boxHeight:3,padding:16}};
  charts['yearly']=new Chart(canvas.getContext('2d'),{type:'line',data:{labels,datasets:[{label:'Your P&L %',data:traderSeries,borderColor:'#6366f1',backgroundColor:'rgba(99,102,241,0.06)',borderWidth:2.5,pointRadius:0,tension:0.3,fill:true},{label:'Nifty 50',data:n50series,borderColor:'#3b82f6',backgroundColor:'transparent',borderWidth:1.5,pointRadius:0,tension:0.3,borderDash:[4,3]},{label:'Nifty 500',data:n500series,borderColor:'#8b5cf6',backgroundColor:'transparent',borderWidth:1.5,pointRadius:0,tension:0.3,borderDash:[2,4]}]},options:{...cfg,interaction:{mode:'index',intersect:false}}});
}
function buildMonthlyChart(allDays){
  destroyChart('monthly');document.getElementById('noDataMonthly').style.display='none';const canvas=document.getElementById('monthlyChart');canvas.style.display='block';
  const monthly={};allDays.forEach(d=>{const m=d.slice(0,7);if(!monthly[m])monthly[m]=0;monthly[m]+=dayPnl(state.days[d]);});
  const labels=Object.keys(monthly).sort();const data=labels.map(m=>parseFloat(monthly[m].toFixed(2)));
  const cfg=getChartDefaults();cfg.plugins.tooltip.callbacks.label=ctx=>`‚Çπ${ctx.parsed.y.toLocaleString('en-IN')}`;cfg.scales.y.ticks.callback=v=>`‚Çπ${v>=0?'+':''}${(v/1000).toFixed(1)}k`;
  charts['monthly']=new Chart(canvas.getContext('2d'),{type:'bar',data:{labels,datasets:[{data,backgroundColor:data.map(v=>v>=0?'rgba(16,185,129,0.15)':'rgba(239,68,68,0.15)'),borderColor:data.map(v=>v>=0?'#10b981':'#ef4444'),borderWidth:2,borderRadius:6}]},options:cfg});
}
function buildWeeklyChart(allDays){
  destroyChart('weekly');document.getElementById('noDataWeekly').style.display='none';const canvas=document.getElementById('weeklyChart');canvas.style.display='block';
  function getWeekKey(ds){const d=new Date(ds);const day=d.getDay(),diff=d.getDate()-day+(day===0?-6:1);return new Date(d.setDate(diff)).toISOString().slice(0,10);}
  const weekly={};allDays.forEach(d=>{const wk=getWeekKey(d);if(!weekly[wk])weekly[wk]=0;weekly[wk]+=dayPnl(state.days[d]);});
  const sorted=Object.keys(weekly).sort().slice(-12);const data=sorted.map(w=>parseFloat(weekly[w].toFixed(2)));
  const cfg=getChartDefaults();cfg.plugins.tooltip.callbacks.label=ctx=>`‚Çπ${ctx.parsed.y.toLocaleString('en-IN')}`;cfg.scales.y.ticks.callback=v=>`‚Çπ${(v/1000).toFixed(1)}k`;
  charts['weekly']=new Chart(canvas.getContext('2d'),{type:'bar',data:{labels:sorted.map(d=>'w/'+d.slice(5)),datasets:[{data,backgroundColor:data.map(v=>v>=0?'rgba(99,102,241,0.15)':'rgba(239,68,68,0.15)'),borderColor:data.map(v=>v>=0?'#6366f1':'#ef4444'),borderWidth:2,borderRadius:6}]},options:cfg});
}
function buildBehaviourGrid(allDays){
  const allTrades=allDays.flatMap(d=>(state.days[d].trades||[]));
  const flagTypes=[{key:'Delayed',label:'Delayed SL',color:'#f59e0b'},{key:'Revenge',label:'Revenge Trade',color:'#ef4444'},{key:'Risky',label:'Risky Setup',color:'#3b82f6'},{key:'FOMO',label:'FOMO Entry',color:'#8b5cf6'},{key:'‚úÖ',label:'Disciplined',color:'#10b981'}];
  if(!allTrades.length){document.getElementById('behaviourGrid').innerHTML=`<div style="text-align:center;padding:24px;color:var(--text-dim);font-size:12px;grid-column:1/-1;">Log trades with behaviour tags to see analysis here.</div>`;return;}
  document.getElementById('behaviourGrid').innerHTML=flagTypes.map(ft=>{const tagged=allTrades.filter(t=>t.flags.some(f=>f.includes(ft.key)));const avg=tagged.length?tagged.reduce((s,t)=>s+t.pnl,0)/tagged.length:0;const wins=tagged.filter(t=>t.pnl>0).length;const wr=tagged.length?Math.round((wins/tagged.length)*100):0;return `<div class="beh-card"><div class="beh-count" style="color:${ft.color}">${tagged.length}</div><div class="beh-label">${ft.label}</div><div class="beh-impact" style="color:${avg>=0?'var(--green)':'var(--red)'}">avg ‚Çπ${avg.toFixed(0)}</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px;font-weight:600;">${wr}% win rate</div></div>`;}).join('');
}
function buildChecklistChart(allDays){
  destroyChart('checklist');document.getElementById('noDataChecklist').style.display='none';const canvas=document.getElementById('checklistChart');canvas.style.display='block';
  const allTrades=allDays.flatMap(d=>(state.days[d].trades||[]));
  if(!allTrades.length){document.getElementById('noDataChecklist').style.display='block';canvas.style.display='none';return;}
  const labels=['Chart Reviewed','Buy/Sell Area','FVG Retest','SL Pre-Defined'];const data=labels.map((_,i)=>{const checked=allTrades.filter(t=>t.checks&&t.checks[i]).length;return Math.round((checked/allTrades.length)*100);});
  const cfg=getChartDefaults();cfg.plugins.tooltip.callbacks.label=ctx=>`${ctx.parsed.x}% compliance`;cfg.scales.x={...cfg.scales.x,min:0,max:100,ticks:{...cfg.scales.x.ticks,callback:v=>v+'%'}};cfg.scales.y={...cfg.scales.y,grid:{display:false},ticks:{color:'#64748b',font:{family:"'DM Sans',sans-serif",size:12}}};delete cfg.scales.y.ticks.callback;
  charts['checklist']=new Chart(canvas.getContext('2d'),{type:'bar',data:{labels,datasets:[{data,backgroundColor:data.map(v=>v>=80?'rgba(16,185,129,0.15)':v>=50?'rgba(245,158,11,0.15)':'rgba(239,68,68,0.15)'),borderColor:data.map(v=>v>=80?'#10b981':v>=50?'#f59e0b':'#ef4444'),borderWidth:2,borderRadius:6}]},options:{...cfg,indexAxis:'y'}});
}

// ‚îÄ‚îÄ DATE/TIME ‚îÄ‚îÄ
function updateDateTime(){const now=new Date();document.getElementById('currentDate').textContent=now.toLocaleDateString('en-IN',{weekday:'short',day:'2-digit',month:'short',year:'numeric'});document.getElementById('currentTime').textContent=now.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',second:'2-digit'});}

// ‚îÄ‚îÄ START APP ‚îÄ‚îÄ
async function startApp(){
  updateDateTime();setInterval(updateDateTime,1000);showQuote(0);setInterval(nextQuote,90000);
  const picker=document.getElementById('datePicker');picker.value=today();picker.max=today();
  await loadAllData();
  setActiveDate(today());
  if(activeDayData().completed){document.getElementById('dayCompleteBtn').classList.add('done');document.getElementById('dayCompleteBtn').textContent='‚úì Day Complete';}
  fetchNiftyData();initNseBar();setSyncStatus('synced','Ready');setTimeout(()=>setSyncStatus('idle',''),2500);
}

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ
window.addEventListener('load',()=>{
  updateDateTime();setInterval(updateDateTime,1000);
  const waitForGSI=setInterval(()=>{if(window.google&&google.accounts){clearInterval(waitForGSI);initGoogleSignIn();}},100);
});
</script>
</body>
</html>
